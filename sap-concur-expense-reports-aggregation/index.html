
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A professional blog showcasing business problem solutions.">
      
      
      
        <link rel="canonical" href="https://Munish-Sethi.github.io/pers-blog/sap-concur-expense-reports-aggregation/">
      
      
        <link rel="prev" href="../sharepoint-site-library-to-azure-fileshare/">
      
      
        <link rel="next" href="../ukg-sftp-file-transfer/">
      
      
      <link rel="icon" href="../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Concur Expense Report Aggregation - Munish(s) Blog</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#automating-sap-concur-expense-report-aggregation-and-adaptive-card-notifications" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Munish(s) Blog" class="md-header__button md-logo" aria-label="Munish(s) Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Munish(s) Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Concur Expense Report Aggregation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Munish(s) Blog" class="md-nav__button md-logo" aria-label="Munish(s) Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Munish(s) Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Azure
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Azure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-ad-certificate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Based Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-billing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Download Azure Bill
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Download Azure Resource
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-query-recovery-services-vault/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Query Recovery Services Vault
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Cisco Meraki & Nagios
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Cisco Meraki & Nagios
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meraki-nagios-device-sync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cisco Meraki Devices Discovery and Nagios Integration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Active Directory Domain Services
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Active Directory Domain Services
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adds-user-creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create ADDS User
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adds-user-update/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Update ADDS User
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    SAP
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            SAP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-rfc-python-container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup PyRFC in your Container
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-rfc-python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Calling SAP RFC Function Modules from Python
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    O365
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            O365
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adaptive-card-consultant-review-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Outlook Actionable Adaptive Card - Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adaptive-card-consultant-review-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Outlook Actionable Adaptive Card - Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-sites-enumeration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sharepoint Sites Enumeration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-site-library-enumeration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sharepoint Document Library Enumeration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-site-library-to-azure-fileshare/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migrate Sharepoint Document Library to Azure File Share
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Concur Expense Report Aggregation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Concur Expense Report Aggregation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-connecting-to-sap-concur-api" class="md-nav__link">
    <span class="md-ellipsis">
      1. Connecting to SAP Concur API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Connecting to SAP Concur API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_scope" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_scope()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_access_token" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_access_token()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_authentication_token" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_authentication_token()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_cached_access_token" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_cached_access_token()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-fetching-users-and-expense-reports" class="md-nav__link">
    <span class="md-ellipsis">
      2. Fetching Users and Expense Reports
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Fetching Users and Expense Reports">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_all_sap_concur_users" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_all_sap_concur_users()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-fetch_expense_reports" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: fetch_expense_reports()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-fetch_all_expense_reports" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: fetch_all_expense_reports()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-processing-and-aggregating-reports" class="md-nav__link">
    <span class="md-ellipsis">
      3. Processing and Aggregating Reports
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Processing and Aggregating Reports">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supporting-function-process_reports" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: process_reports()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregating-by-employee-aggregate_expense_reports_by_employee" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregating by Employee: aggregate_expense_reports_by_employee()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregating-by-organization-aggregate_expense_reports_by_full_oraganization" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregating by Organization: aggregate_expense_reports_by_full_oraganization()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-creating-adaptive-card-emails-summary-vs-detail-toggle" class="md-nav__link">
    <span class="md-ellipsis">
      4. Creating Adaptive Card Emails (Summary vs. Detail Toggle)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Creating Adaptive Card Emails (Summary vs. Detail Toggle)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sending-the-adaptive-card-email" class="md-nav__link">
    <span class="md-ellipsis">
      Sending the Adaptive Card Email
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-end-to-end-workflow-example" class="md-nav__link">
    <span class="md-ellipsis">
      5. End-to-End Workflow Example
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    UKG
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            UKG
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-sftp-file-transfer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secure File Transfer with UKG Dimensions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-api-employee-verification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Employee Verification via API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-api-integration-and-dataview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Automating Integration Execution and Dataview extract
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Proof Point
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Proof Point
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proofpoint-user-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proof Point User Management
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-connecting-to-sap-concur-api" class="md-nav__link">
    <span class="md-ellipsis">
      1. Connecting to SAP Concur API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Connecting to SAP Concur API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_scope" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_scope()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_access_token" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_access_token()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_authentication_token" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_authentication_token()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_cached_access_token" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_cached_access_token()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-fetching-users-and-expense-reports" class="md-nav__link">
    <span class="md-ellipsis">
      2. Fetching Users and Expense Reports
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Fetching Users and Expense Reports">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supporting-function-get_all_sap_concur_users" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: get_all_sap_concur_users()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-fetch_expense_reports" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: fetch_expense_reports()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supporting-function-fetch_all_expense_reports" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: fetch_all_expense_reports()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-processing-and-aggregating-reports" class="md-nav__link">
    <span class="md-ellipsis">
      3. Processing and Aggregating Reports
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Processing and Aggregating Reports">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supporting-function-process_reports" class="md-nav__link">
    <span class="md-ellipsis">
      Supporting Function: process_reports()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregating-by-employee-aggregate_expense_reports_by_employee" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregating by Employee: aggregate_expense_reports_by_employee()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregating-by-organization-aggregate_expense_reports_by_full_oraganization" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregating by Organization: aggregate_expense_reports_by_full_oraganization()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-creating-adaptive-card-emails-summary-vs-detail-toggle" class="md-nav__link">
    <span class="md-ellipsis">
      4. Creating Adaptive Card Emails (Summary vs. Detail Toggle)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Creating Adaptive Card Emails (Summary vs. Detail Toggle)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sending-the-adaptive-card-email" class="md-nav__link">
    <span class="md-ellipsis">
      Sending the Adaptive Card Email
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-end-to-end-workflow-example" class="md-nav__link">
    <span class="md-ellipsis">
      5. End-to-End Workflow Example
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="automating-sap-concur-expense-report-aggregation-and-adaptive-card-notifications">Automating SAP Concur Expense Report Aggregation and Adaptive Card Notifications</h1>
<h2 id="introduction">Introduction</h2>
<p>This article provides a comprehensive, company-agnostic walkthrough for automating SAP Concur expense report aggregation and delivering actionable, interactive notifications to managers using Adaptive Cards. We’ll cover:</p>
<ul>
<li>Securely connecting to SAP Concur with OAuth2</li>
<li>Fetching and processing users and expense reports</li>
<li>Aggregating by employee and by full management chain (organization-wide rollup)</li>
<li>Creating and sending Adaptive Card emails with summary/detail toggles</li>
<li>All supporting functions, with code and explanations</li>
</ul>
<p>By the end, you’ll be able to connect to your own SAP Concur instance and deliver organization-wide expense insights to managers in a modern, interactive format.</p>
<hr />
<h2 id="1-connecting-to-sap-concur-api">1. Connecting to SAP Concur API</h2>
<p>To fetch expense reports, you need to:
- Obtain an OAuth2 access token using your SAP Concur client credentials and refresh token.
- Use the access token to call the Concur API endpoints for users and expense reports.</p>
<h3 id="supporting-function-get_scope">Supporting Function: <code>get_scope()</code></h3>
<p>SAP Concur APIs require a specific OAuth2 scope string. This function returns the required scope for all expense and user operations:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_scope</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="s2">&quot;openid USER user.read user.write LIST spend.list.read spend.listitem.read CONFIG EXPRPT FISVC &quot;</span>
        <span class="s2">&quot;creditcardaccount.read IMAGE expense.exchangerate.writeonly profile.user.generaluser.read &quot;</span>
        <span class="s2">&quot;profile.user.generalemployee.read expense.report.read expense.report.readwrite spend.list.write &quot;</span>
        <span class="s2">&quot;spend.listitem.write identity.user.ids.read identity.user.core.read identity.user.coresensitive.read &quot;</span>
        <span class="s2">&quot;identity.user.enterprise.read identity.user.event.read&quot;</span>
    <span class="p">)</span>
</code></pre></div>
<h3 id="supporting-function-get_access_token">Supporting Function: <code>get_access_token()</code></h3>
<p>This function retrieves an OAuth2 access token using your client ID, secret, and refresh token:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_access_token</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_authentication_token</span><span class="p">(</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">SAP_CONCUR_CLIENT_APP_ID</span><span class="p">,</span>
            <span class="n">client_secret</span><span class="o">=</span><span class="n">SAP_CONCUR_CLIENT_SECRET</span><span class="p">,</span>
            <span class="n">refresh_token</span><span class="o">=</span><span class="n">SAP_CONCUR_REFRESH_TOKEN</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="n">get_scope</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">handle_global_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<h3 id="supporting-function-get_authentication_token">Supporting Function: <code>get_authentication_token()</code></h3>
<p>Handles the actual OAuth2 token request:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_authentication_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">client_secret</span><span class="p">,</span> <span class="n">refresh_token</span><span class="p">,</span> <span class="n">scope</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;grant_type&quot;</span><span class="p">:</span> <span class="s2">&quot;refresh_token&quot;</span><span class="p">,</span>
        <span class="s2">&quot;refresh_token&quot;</span><span class="p">:</span> <span class="n">refresh_token</span><span class="p">,</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="n">scope</span><span class="p">,</span>
        <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
        <span class="s2">&quot;client_secret&quot;</span><span class="p">:</span> <span class="n">client_secret</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SAP_CONCUR_OAUTH_END_POINT</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;access_token&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="supporting-function-get_cached_access_token">Supporting Function: <code>get_cached_access_token()</code></h3>
<p>Caches the access token to avoid unnecessary requests:</p>
<div class="highlight"><pre><span></span><code><span class="n">access_token_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_cached_access_token</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">access_token_cache</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">access_token_cache</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">access_token_cache</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span>
    <span class="n">new_token</span> <span class="o">=</span> <span class="n">get_access_token</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">new_token</span><span class="p">:</span>
        <span class="n">access_token_cache</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_token</span>
        <span class="n">access_token_cache</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_token</span>
</code></pre></div>
<hr />
<h2 id="2-fetching-users-and-expense-reports">2. Fetching Users and Expense Reports</h2>
<h3 id="supporting-function-get_all_sap_concur_users">Supporting Function: <code>get_all_sap_concur_users()</code></h3>
<p>Fetches all users from SAP Concur (with pagination):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_sap_concur_users</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">access_token</span> <span class="o">=</span> <span class="n">get_cached_access_token</span><span class="p">()</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="s2">&quot;https://us.api.concursolutions.com/profile/identity/v4.1/Users&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
        <span class="p">}</span>
        <span class="n">all_users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">next_cursor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span>
            <span class="k">if</span> <span class="n">next_cursor</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;?cursor=</span><span class="si">{</span><span class="n">next_cursor</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">all_users</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">next_cursor</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nextCursor&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">next_cursor</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">all_users</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">handle_global_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div>
<h3 id="supporting-function-fetch_expense_reports">Supporting Function: <code>fetch_expense_reports()</code></h3>
<p>Fetches all expense reports for a given user:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fetch_expense_reports</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">query_parameters</span><span class="p">):</span>
    <span class="n">access_token</span> <span class="o">=</span> <span class="n">get_cached_access_token</span><span class="p">()</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://us.api.concursolutions.com/api/v3.0/expense/reports&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
    <span class="n">reports</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">next_page</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">?user=</span><span class="si">{</span><span class="n">user_name</span><span class="si">}{</span><span class="n">query_parameters</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">while</span> <span class="n">next_page</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">next_page</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">reports</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Items&quot;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NextPage&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reports</span>
</code></pre></div>
<h3 id="supporting-function-fetch_all_expense_reports">Supporting Function: <code>fetch_all_expense_reports()</code></h3>
<p>Fetches all reports for all users:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fetch_all_expense_reports</span><span class="p">(</span><span class="n">user_mappings</span><span class="p">,</span> <span class="n">query_parameters</span><span class="p">):</span>
    <span class="n">all_reports</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">user_mappings</span><span class="p">:</span>
        <span class="n">reports</span> <span class="o">=</span> <span class="n">fetch_expense_reports</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">query_parameters</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">reports</span><span class="p">:</span>
            <span class="n">report</span><span class="p">[</span><span class="s2">&quot;UserId&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
        <span class="n">all_reports</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">reports</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_reports</span>
</code></pre></div>
<hr />
<h2 id="3-processing-and-aggregating-reports">3. Processing and Aggregating Reports</h2>
<h3 id="supporting-function-process_reports">Supporting Function: <code>process_reports()</code></h3>
<p>Normalizes report data for aggregation:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_reports</span><span class="p">(</span><span class="n">all_reports</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;UserId&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UserId&quot;</span><span class="p">),</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">),</span>
            <span class="s2">&quot;Total&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Total&quot;</span><span class="p">),</span>
            <span class="s2">&quot;CurrencyCode&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CurrencyCode&quot;</span><span class="p">),</span>
            <span class="s2">&quot;SubmitDate&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SubmitDate&quot;</span><span class="p">),</span>
            <span class="s2">&quot;OwnerLoginID&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OwnerLoginID&quot;</span><span class="p">),</span>
            <span class="s2">&quot;OwnerName&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OwnerName&quot;</span><span class="p">),</span>
            <span class="s2">&quot;ApproverLoginID&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApproverLoginID&quot;</span><span class="p">),</span>
            <span class="s2">&quot;ApproverName&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApproverName&quot;</span><span class="p">),</span>
            <span class="s2">&quot;ApprovalStatusName&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApprovalStatusName&quot;</span><span class="p">),</span>
            <span class="s2">&quot;ApprovalStatusCode&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApprovalStatusCode&quot;</span><span class="p">),</span>
            <span class="s2">&quot;PaymentStatusName&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PaymentStatusName&quot;</span><span class="p">),</span>
            <span class="s2">&quot;PaymentStatusCode&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PaymentStatusCode&quot;</span><span class="p">),</span>
            <span class="s2">&quot;LastModifiedDate&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LastModifiedDate&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AmountDueEmployee&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AmountDueEmployee&quot;</span><span class="p">),</span>
            <span class="s2">&quot;AmountDueCompanyCard&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;AmountDueCompanyCard&quot;</span><span class="p">),</span>
            <span class="s2">&quot;TotalClaimedAmount&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TotalClaimedAmount&quot;</span><span class="p">),</span>
            <span class="s2">&quot;TotalApprovedAmount&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;TotalApprovedAmount&quot;</span><span class="p">),</span>
            <span class="s2">&quot;LedgerName&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LedgerName&quot;</span><span class="p">),</span>
            <span class="s2">&quot;PolicyID&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PolicyID&quot;</span><span class="p">),</span>
            <span class="s2">&quot;EverSentBack&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EverSentBack&quot;</span><span class="p">),</span>
            <span class="s2">&quot;HasException&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;HasException&quot;</span><span class="p">),</span>
            <span class="s2">&quot;URI&quot;</span><span class="p">:</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;URI&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">all_reports</span>
    <span class="p">]</span>
</code></pre></div>
<h3 id="aggregating-by-employee-aggregate_expense_reports_by_employee">Aggregating by Employee: <code>aggregate_expense_reports_by_employee()</code></h3>
<p>Groups and sums expense reports for each employee, optionally by approval status or by individual report.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_expense_reports_by_employee</span><span class="p">(</span><span class="n">processed_reports</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
    <span class="n">employee_reports</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">processed_reports</span><span class="p">:</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OwnerLoginID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">report_name</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">report_id</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ReportID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">approval_status_code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApprovalStatusCode&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">approval_status_name</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApprovalStatusName&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">approval_status_code</span><span class="si">}</span><span class="s2">-(</span><span class="si">{</span><span class="n">approval_status_name</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="n">summary</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">report_name</span><span class="si">}</span><span class="s2">-(</span><span class="si">{</span><span class="n">report_id</span><span class="si">}</span><span class="s2">)-</span><span class="si">{</span><span class="n">approval_status_code</span><span class="si">}</span><span class="s2">-(</span><span class="si">{</span><span class="n">approval_status_name</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">employee_reports</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">employee_reports</span><span class="p">[</span><span class="n">user_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total</span>
    <span class="k">return</span> <span class="n">employee_reports</span>
</code></pre></div>
<h3 id="aggregating-by-organization-aggregate_expense_reports_by_full_oraganization">Aggregating by Organization: <code>aggregate_expense_reports_by_full_oraganization()</code></h3>
<p>Rolls up expense totals for each manager, including all direct and indirect reports, using a recursive helper.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_expense_reports_by_full_oraganization</span><span class="p">(</span><span class="n">processed_reports</span><span class="p">,</span> <span class="n">management_upns</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
    <span class="n">object_organization_reports</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Build a reverse mapping of manager to their direct reports</span>
    <span class="n">manager_to_reports</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">employee</span><span class="p">,</span> <span class="n">details</span> <span class="ow">in</span> <span class="n">management_upns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;manager&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">manager</span><span class="p">:</span>
            <span class="n">manager_to_reports</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">employee</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_totals_upwards</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">visited</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">manager</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_organization_reports</span><span class="p">:</span>
            <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">manager</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">employee</span> <span class="ow">in</span> <span class="n">manager_to_reports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">aggregate_totals_upwards</span><span class="p">(</span><span class="n">employee</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">total</span> <span class="ow">in</span> <span class="n">object_organization_reports</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">employee</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">manager</span><span class="p">]:</span>
                    <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">manager</span><span class="p">][</span><span class="n">status</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">manager</span><span class="p">][</span><span class="n">status</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total</span>
    <span class="c1"># Populate initial totals for each employee based on processed reports</span>
    <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">processed_reports</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UserManager&quot;</span><span class="p">):</span>
            <span class="n">user_manager</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;UserManager&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">approval_status_code</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApprovalStatusCode&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">approval_status_name</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ApprovalStatusName&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OwnerLoginID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">approval_status_code</span><span class="si">}</span><span class="s2">-(</span><span class="si">{</span><span class="n">approval_status_name</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">summary</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">approval_status_code</span><span class="si">}</span><span class="s2">-(</span><span class="si">{</span><span class="n">approval_status_name</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Total&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_manager</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_organization_reports</span><span class="p">:</span>
            <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">user_manager</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">user_manager</span><span class="p">]:</span>
            <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">user_manager</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">object_organization_reports</span><span class="p">[</span><span class="n">user_manager</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">total</span>
    <span class="c1"># Aggregate totals upwards starting from all unique managers</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="n">manager_to_reports</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">aggregate_totals_upwards</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">visited</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">object_organization_reports</span>
</code></pre></div>
<hr />
<h2 id="4-creating-adaptive-card-emails-summary-vs-detail-toggle">4. Creating Adaptive Card Emails (Summary vs. Detail Toggle)</h2>
<p>Adaptive Cards are JSON payloads that Outlook and Teams can render as interactive UI. Here’s how to create a card with a summary and a toggle for details:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_adaptive_info_card_for_manager</span><span class="p">(</span><span class="n">manager_email</span><span class="p">,</span> <span class="n">summary_by_employee</span><span class="p">,</span> <span class="n">summary_by_organization</span><span class="p">,</span> <span class="n">detail_by_organization</span><span class="p">,</span> <span class="n">user_expense_reports</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">summary_total</span> <span class="o">=</span> <span class="n">summary_by_organization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manager_email</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">detail_items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TextBlock&quot;</span><span class="p">,</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">summary_by_employee</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;wrap&quot;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">detail_by_organization</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">manager_email</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">]</span>
        <span class="n">adaptive_card</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;AdaptiveCard&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TextBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Expense Report Summary&quot;</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="s2">&quot;Bolder&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="s2">&quot;Large&quot;</span><span class="p">},</span>
                <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TextBlock&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Total for your organization: </span><span class="si">{</span><span class="n">summary_total</span><span class="si">:</span><span class="s2">,.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;wrap&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;TextBlock&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Click below to view details.&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;wrap&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;spacing&quot;</span><span class="p">:</span> <span class="s2">&quot;Medium&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Container&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;detailsContainer&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;isVisible&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="n">detail_items</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Action.ToggleVisibility&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Show/Hide Details&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;targetElements&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;detailsContainer&quot;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">adaptive_card</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">handle_global_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<h3 id="sending-the-adaptive-card-email">Sending the Adaptive Card Email</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">send_adaptive_info_email_to_manager</span><span class="p">(</span><span class="n">manager_email</span><span class="p">,</span> <span class="n">summary_by_employee</span><span class="p">,</span> <span class="n">summary_by_organization</span><span class="p">,</span> <span class="n">detail_by_organization</span><span class="p">,</span> <span class="n">user_expense_reports</span><span class="p">):</span>
    <span class="n">adaptive_card</span> <span class="o">=</span> <span class="n">create_adaptive_info_card_for_manager</span><span class="p">(</span>
        <span class="n">manager_email</span><span class="p">,</span> <span class="n">summary_by_employee</span><span class="p">,</span> <span class="n">summary_by_organization</span><span class="p">,</span> <span class="n">detail_by_organization</span><span class="p">,</span> <span class="n">user_expense_reports</span>
    <span class="p">)</span>
    <span class="n">email_payload</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="s2">&quot;Expense Report Summary&quot;</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;contentType&quot;</span><span class="p">:</span> <span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&#39;Content-Type&#39; content=&#39;text/html; charset=utf-8&#39;&gt;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;script type=&#39;application/adaptivecard+json&#39;&gt;</span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">adaptive_card</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/script&gt;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;/head&gt;&lt;body&gt;&lt;p&gt;&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>
                <span class="p">)</span>
            <span class="p">},</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;emailAddress&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">SMTP_FROM_SEND_EMAIL</span><span class="p">}},</span>
            <span class="s2">&quot;toRecipients&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;emailAddress&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">manager_email</span><span class="p">}}],</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">send_adaptive_card_email</span><span class="p">(</span><span class="n">email_payload</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="5-end-to-end-workflow-example">5. End-to-End Workflow Example</h2>
<p>Here’s a high-level workflow you can adapt:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 1. Fetch management hierarchy from your HR system</span>
    <span class="n">management_upns</span> <span class="o">=</span> <span class="n">fetch_management_upns</span><span class="p">()</span>  <span class="c1"># {employee: {&quot;manager&quot;: manager_email, ...}}</span>
    <span class="c1"># 2. Fetch all SAP Concur users</span>
    <span class="n">sap_concur_users</span> <span class="o">=</span> <span class="n">get_all_sap_concur_users</span><span class="p">()</span>
    <span class="c1"># 3. Fetch all expense reports for all users</span>
    <span class="n">all_reports</span> <span class="o">=</span> <span class="n">fetch_all_expense_reports</span><span class="p">(</span><span class="n">sap_concur_users</span><span class="p">,</span> <span class="s2">&quot;&amp;submitDateAfter=2025-01-01&quot;</span><span class="p">)</span>
    <span class="c1"># 4. Normalize and process reports</span>
    <span class="n">processed_reports</span> <span class="o">=</span> <span class="n">process_reports</span><span class="p">(</span><span class="n">all_reports</span><span class="p">)</span>
    <span class="c1"># 5. Aggregate by employee and organization</span>
    <span class="n">summary_by_employee</span> <span class="o">=</span> <span class="n">aggregate_expense_reports_by_employee</span><span class="p">(</span><span class="n">processed_reports</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">summary_by_organization</span> <span class="o">=</span> <span class="n">aggregate_expense_reports_by_full_oraganization</span><span class="p">(</span><span class="n">processed_reports</span><span class="p">,</span> <span class="n">management_upns</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">detail_by_organization</span> <span class="o">=</span> <span class="n">aggregate_expense_reports_by_full_oraganization</span><span class="p">(</span><span class="n">processed_reports</span><span class="p">,</span> <span class="n">management_upns</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># 6. Send Adaptive Card emails to each manager</span>
    <span class="k">for</span> <span class="n">manager_email</span> <span class="ow">in</span> <span class="n">summary_by_organization</span><span class="p">:</span>
        <span class="n">send_adaptive_info_email_to_manager</span><span class="p">(</span>
            <span class="n">manager_email</span><span class="p">,</span> <span class="n">summary_by_employee</span><span class="p">,</span> <span class="n">summary_by_organization</span><span class="p">,</span> <span class="n">detail_by_organization</span><span class="p">,</span> <span class="n">processed_reports</span>
        <span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="references">References</h2>
<ul>
<li><a href="https://developer.concur.com/api-reference/">SAP Concur API Reference</a></li>
<li><a href="https://adaptivecards.io/">Microsoft Adaptive Cards</a></li>
<li><a href="https://learn.microsoft.com/en-us/graph/api/resources/mail-api-overview">Microsoft Graph API for Sending Mail</a></li>
</ul>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>With these patterns and supporting functions, you can connect to your own SAP Concur instance, fetch and aggregate expense reports by employee and by full reporting chain, and deliver actionable, interactive notifications to managers using Adaptive Cards. This enables powerful, organization-wide financial insights and automated reporting for managers at every level.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="June 30, 2025 21:58:08 UTC">June 30, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "content.code.annotate", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../assets/custom.js"></script>
      
    
  </body>
</html>