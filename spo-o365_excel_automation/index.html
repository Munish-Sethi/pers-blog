
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A professional blog showcasing business problem solutions.">
      
      
      
        <link rel="canonical" href="https://munishsethi.com/spo-o365_excel_automation/">
      
      
        <link rel="prev" href="../email-o365-proofpoint-part5/">
      
      
        <link rel="next" href="../ukg-sftp-file-transfer/">
      
      
        
      
      
      <link rel="icon" href="../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>O365/Excel Automation via SPO - Munish(s) Blog</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#programmatically-editing-excel-files-on-sharepoint-online-with-python" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Munish(s) Blog" class="md-header__button md-logo" aria-label="Munish(s) Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Munish(s) Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              O365/Excel Automation via SPO
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Munish(s) Blog" class="md-nav__button md-logo" aria-label="Munish(s) Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Munish(s) Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    AI
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    AI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai-claude-mcp-analytic-server-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Analysis with LLM via MCP Server (csv/Parquet) stdio- Part 1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai-claude-mcp-analytic-server-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Analysis with LLM via MCP Server (database) stdio- Part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai-claude-mcp-analytic-server-part3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Analysis with LLM via MCP Server (files/database) https- Part 3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai-claude-mcp-analytic-server-part4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debugging MCP Servers (Https) with VS Code - Part 4
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Azure
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Azure
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-ad-certificate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Certificate Based Authentication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-billing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Download Azure Bill
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Download Azure Resource
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-query-recovery-services-vault/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Query Recovery Services Vault
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-ad-user/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entra Users, User Groups and Licence assignments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-ad-user-devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entra User Devices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-container-schedule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Orchestrating Scheduled Jobs (Container Instances)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops-build-container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DevOps Build Container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops-deploy-container-iac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DevOps Deploy Container IaC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops-deploy-container-github-action/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DevOps Deploy Container Github Actions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../avd-custon-image-compute-gallery-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building and Publishing an Custom Image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../avd-publish-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying Azure Virtual Desktop (AVD) Desktops
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../avd-cleanup-obsolete-fsLogix-profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cleanup Obsolete FXLogix Profiles(AVD)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-bcpdr-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Business Coninuity Program / Diasister Recovery - Part 1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-bcpdr-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Business Continuity Program / Disaster Recovery - Part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-bcpdr-github-action/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Business Continuity Program / Disaster Recovery - Git Hub Action
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-restore-from-backup-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Restore VM from RSV Backup - Part 1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-restore-from-backup-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Restore VM from RSV Backup - Part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Fabric
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Fabric
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fabric-wharehouse-fact-import/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Warehouse data import
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Cisco Meraki, Nagios XI & Manage Engine
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cisco Meraki, Nagios XI & Manage Engine
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meraki-unused-device-sync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cisco Meraki Unused Devices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meraki-nagios-device-sync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cisco Meraki Devices Discovery and Nagios Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring-itsm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integrating Monitoring System with ITSM System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meraki-vm-deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying Cisco Meraki vMX
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Active Directory Domain Services
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Active Directory Domain Services
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adds-user-creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Create ADDS User
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adds-user-update/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Update ADDS User
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    SAP
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    SAP
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-rfc-python-container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setup PyRFC in your Container
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-rfc-python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Calling SAP RFC Function Modules from Python
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-system-start-stop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automating SAP System Start/Stop Operations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    O365
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    O365
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adaptive-card-consultant-review-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Outlook Actionable Adaptive Card - Part 1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adaptive-card-consultant-review-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Outlook Actionable Adaptive Card - Part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-sites-enumeration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sharepoint Sites Enumeration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-site-library-enumeration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sharepoint Document Library Enumeration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-site-library-to-azure-fileshare/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migrate Sharepoint Document Library to Azure File Share
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-concur-expense-reports-aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Concur Expense Report Aggregation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../teams-user-number-assignment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Get all Teams Phone Assignment(s)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deprovision-user/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deprovison User
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tenantallowblocklist/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tenant Allow Block List - False Positive
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    O365 and Proof Point Essentials - Part 1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    O365 and Proof Point Essentials - Part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    O365 and Proof Point Essentials - Part 3
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    O365 and Proof Point Essentials - Part 4
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    O365 and Proof Point Essentials - Part 5
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    O365/Excel Automation via SPO
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    O365/Excel Automation via SPO
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-business-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Business Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-challenge" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Challenge
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-this-article-demonstrates" class="md-nav__link">
    <span class="md-ellipsis">
      
        What This Article Demonstrates
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication-and-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication and Permissions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Authentication and Permissions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-graph-api-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Required Graph API Permissions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication Code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-your-excel-workbook" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration for Your Excel Workbook
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-this-approach-wins-comparison-with-alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why This Approach Wins: Comparison with Alternatives
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why This Approach Wins: Comparison with Alternatives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-advantages-of-graph-api-approach" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Advantages of Graph API Approach
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-this-approach-is-ideal" class="md-nav__link">
    <span class="md-ellipsis">
      
        When This Approach Is Ideal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-consider-alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Consider Alternatives
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connecting-to-the-excel-file-on-spo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connecting to the Excel File on SPO
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-and-closing-workbook-sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating and Closing Workbook Sessions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listing-worksheets-and-charts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Listing Worksheets and Charts
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#injecting-data-into-excel-worksheets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Injecting Data into Excel Worksheets
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Injecting Data into Excel Worksheets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cell-update-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cell Update Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-driven-workbook-update" class="md-nav__link">
    <span class="md-ellipsis">
      
        JSON-Driven Workbook Update
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-json-input-file" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example JSON Input File
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#looping-through-worksheets-and-extracting-charts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Looping Through Worksheets and Extracting Charts
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-web-interface-with-flask" class="md-nav__link">
    <span class="md-ellipsis">
      
        Building the Web Interface with Flask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building the Web Interface with Flask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flask-application-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flask Application Setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-pump-comparison-web-route" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Pump Comparison Web Route
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features-of-the-web-interface" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features of the Web Interface
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#html-form-template" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTML Form Template
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end-workflow-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        End-to-End Workflow Example
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-professional-pdf-reports-with-reportlab" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generating Professional PDF Reports with ReportLab
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generating Professional PDF Reports with ReportLab">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-pdf-generation-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete PDF Generation Code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integrating-pdf-generation-into-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integrating PDF Generation into the Workflow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-pdf-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key PDF Features
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#email-automation-delivering-reports-to-recipients" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Automation: Delivering Reports to Recipients
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Email Automation: Delivering Reports to Recipients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#email-sending-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Sending Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flask-route-for-user-triggered-email-sending" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flask Route for User-Triggered Email Sending
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#email-form-in-results-page" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Form in Results Page
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#email-integration-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Integration Options
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-email-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Email Features
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-considerations-performance-security-and-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Considerations: Performance, Security, and Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production Considerations: Performance, Security, and Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Optimization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Considerations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-and-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling and Resilience
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limitations-and-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Limitations and Considerations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conclusion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-power-of-separation-of-concerns" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Power of Separation of Concerns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-weve-built" class="md-nav__link">
    <span class="md-ellipsis">
      
        What We've Built
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-this-approach-wins" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why This Approach Wins
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#real-world-applicability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Real-World Applicability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-technical-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Technical Takeaways
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-bottom-line" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Bottom Line
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Further Reading
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    UKG
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    UKG
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-sftp-file-transfer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Secure File Transfer with UKG Dimensions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-api-employee-verification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Employee Verification via API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-api-integration-and-dataview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Automating Integration Execution and Dataview extract
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Misc
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Misc
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proofpoint-user-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Proof Point User Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../github-clean-deployments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Clean GitHub Deployments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proofpointo365connector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Understanding DMARC/Spoofing, O365 with ProofPoint
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Introduction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-business-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Business Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-challenge" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Challenge
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-this-article-demonstrates" class="md-nav__link">
    <span class="md-ellipsis">
      
        What This Article Demonstrates
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#authentication-and-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication and Permissions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Authentication and Permissions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-graph-api-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Required Graph API Permissions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication Code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-for-your-excel-workbook" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration for Your Excel Workbook
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-this-approach-wins-comparison-with-alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why This Approach Wins: Comparison with Alternatives
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why This Approach Wins: Comparison with Alternatives">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-advantages-of-graph-api-approach" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Advantages of Graph API Approach
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-this-approach-is-ideal" class="md-nav__link">
    <span class="md-ellipsis">
      
        When This Approach Is Ideal
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-consider-alternatives" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Consider Alternatives
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connecting-to-the-excel-file-on-spo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Connecting to the Excel File on SPO
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-and-closing-workbook-sessions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating and Closing Workbook Sessions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listing-worksheets-and-charts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Listing Worksheets and Charts
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#injecting-data-into-excel-worksheets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Injecting Data into Excel Worksheets
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Injecting Data into Excel Worksheets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cell-update-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cell Update Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#json-driven-workbook-update" class="md-nav__link">
    <span class="md-ellipsis">
      
        JSON-Driven Workbook Update
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-json-input-file" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example JSON Input File
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#looping-through-worksheets-and-extracting-charts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Looping Through Worksheets and Extracting Charts
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#building-the-web-interface-with-flask" class="md-nav__link">
    <span class="md-ellipsis">
      
        Building the Web Interface with Flask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Building the Web Interface with Flask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#flask-application-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flask Application Setup
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-pump-comparison-web-route" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Pump Comparison Web Route
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features-of-the-web-interface" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Features of the Web Interface
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#html-form-template" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTML Form Template
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-to-end-workflow-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        End-to-End Workflow Example
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generating-professional-pdf-reports-with-reportlab" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generating Professional PDF Reports with ReportLab
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generating Professional PDF Reports with ReportLab">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#complete-pdf-generation-code" class="md-nav__link">
    <span class="md-ellipsis">
      
        Complete PDF Generation Code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integrating-pdf-generation-into-the-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Integrating PDF Generation into the Workflow
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-pdf-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key PDF Features
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#email-automation-delivering-reports-to-recipients" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Automation: Delivering Reports to Recipients
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Email Automation: Delivering Reports to Recipients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#email-sending-function" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Sending Function
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flask-route-for-user-triggered-email-sending" class="md-nav__link">
    <span class="md-ellipsis">
      
        Flask Route for User-Triggered Email Sending
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#email-form-in-results-page" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Form in Results Page
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#email-integration-options" class="md-nav__link">
    <span class="md-ellipsis">
      
        Email Integration Options
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-email-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Email Features
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#production-considerations-performance-security-and-error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Production Considerations: Performance, Security, and Error Handling
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Production Considerations: Performance, Security, and Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Performance Optimization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Security Considerations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling-and-resilience" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling and Resilience
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#limitations-and-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Limitations and Considerations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Conclusion
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conclusion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-power-of-separation-of-concerns" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Power of Separation of Concerns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#what-weve-built" class="md-nav__link">
    <span class="md-ellipsis">
      
        What We've Built
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-this-approach-wins" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why This Approach Wins
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#real-world-applicability" class="md-nav__link">
    <span class="md-ellipsis">
      
        Real-World Applicability
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-technical-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        Key Technical Takeaways
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-bottom-line" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Bottom Line
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-reading" class="md-nav__link">
    <span class="md-ellipsis">
      
        Further Reading
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="programmatically-editing-excel-files-on-sharepoint-online-with-python">Programmatically Editing Excel Files on SharePoint Online with Python</h1>
<h2 id="introduction">Introduction</h2>
<p>Have you ever faced a situation where users have built a complex Excel workbook with intricate formulas, VLOOKUPs, cross-sheet references, and embedded chartsand now they want a web interface for data entry, but <strong>without duplicating the Excel logic</strong>?</p>
<p>This is exactly the challenge our Engineering Department faced. They had a sophisticated pump comparison workbook (<code>.xlsx</code> file, no macros) with multiple worksheets containing complicated formulas and inter-sheet dependencies. Once data was input into the data input sheet, various VLOOKUPs and formulas would refresh all dependent worksheets, which contained embedded graphs showing comparative analysis.</p>
<h3 id="the-business-requirements">The Business Requirements</h3>
<p>The engineering team wanted to:
1. <strong>Create a web interface</strong> for users to input pump comparison parameters
2. <strong>Reuse the existing Excel logic</strong> (not rebuild formulas in code)
3. <strong>Inject data</strong> into the Excel input worksheet programmatically
4. <strong>Let Excel recalculate</strong> all formulas and charts automatically
5. <strong>Export the refreshed charts</strong> from Excel as images
6. <strong>Generate a PDF report</strong> combining all charts
7. <strong>Email the PDF</strong> to specified recipients</p>
<h3 id="the-challenge">The Challenge</h3>
<p>Traditionally, this would require one of these approaches:
- <strong>COM Automation</strong>: Requires Excel installation on the server, Windows-only, licensing costs, not cloud-ready
- <strong>Third-party libraries</strong> (openpyxl, xlwings): Cannot execute Excel formulas, would need to duplicate all logic in Python
- <strong>Rebuild everything in code</strong>: Weeks of development to replicate complex Excel formulas, error-prone, hard to maintain</p>
<h3 id="solution">Solution</h3>
<p>What if we could <strong>store the Excel file on SharePoint</strong>, <strong>open it programmatically via Microsoft Graph API</strong>, <strong>inject data without needing Excel installed</strong>, and let Excel's native calculation engine do all the work?</p>
<p>This is exactly what we builtand it's surprisingly simple.</p>
<h3 id="what-this-article-demonstrates">What This Article Demonstrates</h3>
<p>This article shows you how to:
- Open and edit an <code>.xlsx</code> file on SharePoint Online using Python and Microsoft Graph API
- Inject data into worksheets, triggering automatic formula recalculation
- Extract refreshed charts as PNG images
- Build a complete Flask web application for user input
- Generate professional PDF reports with ReportLab
- Automate email distribution with attachments
- Deploy a production-ready solution without Excel components or third-party Excel libraries</p>
<p><strong>The result?</strong> A simple, cloud-native solution to a complex problemavoiding weeks of development time and eliminating ongoing maintenance of duplicated Excel logic.</p>
<hr />
<h2 id="authentication-and-permissions">Authentication and Permissions</h2>
<p>Our solution uses <strong>Azure AD Service Principal with certificate-based authentication</strong> for secure, automated access to SharePoint Online.</p>
<blockquote>
<p>For detailed authentication setup and certificate-based SPN configuration, see my previous blog article:
- <a href="../azure-ad-certificate/">Certificate Based Authentication</a></p>
</blockquote>
<h3 id="required-graph-api-permissions">Required Graph API Permissions</h3>
<p>The Azure AD App Registration requires these <strong>Application Permissions</strong> (not delegated):</p>
<ul>
<li><code>Files.ReadWrite.All</code> - Read and write files in all site collections</li>
<li><code>Sites.ReadWrite.All</code> - Access SharePoint sites</li>
<li><code>User.Read</code> - Read basic user profile</li>
<li><code>offline_access</code> - Maintain access to data</li>
</ul>
<h3 id="authentication-code">Authentication Code</h3>
<p>The production code uses the Microsoft Authentication Library (MSAL) to acquire access tokens:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">msal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="c1"># Azure AD Configuration</span>
<span class="n">TENANT_ID</span> <span class="o">=</span> <span class="s2">&quot;your-tenant-id&quot;</span>
<span class="n">CLIENT_ID</span> <span class="o">=</span> <span class="s2">&quot;your-client-id&quot;</span>
<span class="n">CERTIFICATE_PATH</span> <span class="o">=</span> <span class="s2">&quot;/path/to/certificate.pem&quot;</span>
<span class="n">THUMBPRINT</span> <span class="o">=</span> <span class="s2">&quot;certificate-thumbprint&quot;</span>
<span class="n">AUTHORITY</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://login.microsoftonline.com/</span><span class="si">{</span><span class="n">TENANT_ID</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">SCOPES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://graph.microsoft.com/.default&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_access_token_API_Access_AAD</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Acquire access token using certificate-based authentication.</span>
<span class="sd">    Returns a valid access token for Microsoft Graph API calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Load the certificate</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CERTIFICATE_PATH</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cert_file</span><span class="p">:</span>
            <span class="n">certificate</span> <span class="o">=</span> <span class="n">cert_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="c1"># Create MSAL confidential client application</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">msal</span><span class="o">.</span><span class="n">ConfidentialClientApplication</span><span class="p">(</span>
            <span class="n">CLIENT_ID</span><span class="p">,</span>
            <span class="n">authority</span><span class="o">=</span><span class="n">AUTHORITY</span><span class="p">,</span>
            <span class="n">client_credential</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;thumbprint&quot;</span><span class="p">:</span> <span class="n">THUMBPRINT</span><span class="p">,</span>
                <span class="s2">&quot;private_key&quot;</span><span class="p">:</span> <span class="n">certificate</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Acquire token from cache or request new one</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">acquire_token_silent</span><span class="p">(</span><span class="n">SCOPES</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">acquire_token_for_client</span><span class="p">(</span><span class="n">scopes</span><span class="o">=</span><span class="n">SCOPES</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;access_token&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;access_token&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_description&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to acquire token: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authentication error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="c1"># Azure Graph API base URL</span>
<span class="n">AZURE_GRAPH_V1</span> <span class="o">=</span> <span class="s2">&quot;https://graph.microsoft.com/v1.0/&quot;</span>
</code></pre></div>
<h3 id="configuration-for-your-excel-workbook">Configuration for Your Excel Workbook</h3>
<p>You'll need to identify your SharePoint Drive ID and Excel file Item ID:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># SharePoint Drive and Item IDs</span>
<span class="n">DRIVE_ID</span> <span class="o">=</span> <span class="s1">&#39;u9lKkdkMJrbBGuSPA3SOEES-Q6_dw04h-byj&#39;</span>
<span class="n">ITEM_ID</span> <span class="o">=</span> <span class="s1">&#39;01WWHOXQPRVTA47QWLKVA34C4X56SD3KQB&#39;</span>

<span class="c1"># Construct workbook base URL</span>
<span class="n">WORKBOOK_BASE</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AZURE_GRAPH_V1</span><span class="si">}</span><span class="s2">drives/</span><span class="si">{</span><span class="n">DRIVE_ID</span><span class="si">}</span><span class="s2">/items/</span><span class="si">{</span><span class="n">ITEM_ID</span><span class="si">}</span><span class="s2">/workbook&quot;</span>
</code></pre></div>
<p><strong>How to find your Drive ID and Item ID:</strong></p>
<ol>
<li>Navigate to your SharePoint document library in a browser</li>
<li>Right-click on the Excel file and select "Details"</li>
<li>Use Microsoft Graph Explorer or the REST API to query file metadata:
   <div class="highlight"><pre><span></span><code>GET https://graph.microsoft.com/v1.0/sites/{site-id}/drive/root:/path/to/file.xlsx
</code></pre></div></li>
</ol>
<p>Once authenticated, you can use the access token to interact with the Excel file on SPO.</p>
<hr />
<h2 id="why-this-approach-wins-comparison-with-alternatives">Why This Approach Wins: Comparison with Alternatives</h2>
<p>Before diving into the implementation, let's understand why the Microsoft Graph API approach is superior to traditional methods:</p>
<table>
<thead>
<tr>
<th>Approach</th>
<th>Implementation Complexity</th>
<th>Maintenance Burden</th>
<th>Infrastructure Requirements</th>
<th>Formula Execution</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Microsoft Graph API</strong> </td>
<td>Low - REST API calls</td>
<td>Minimal - Excel team maintains formulas</td>
<td>Cloud-native, no servers</td>
<td>Native Excel engine</td>
<td>Free (O365 license)</td>
</tr>
<tr>
<td><strong>COM Automation</strong></td>
<td>High - COM interop, Windows-specific</td>
<td>High - Server maintenance, Excel licensing</td>
<td>Windows Server, Excel installation</td>
<td>Native Excel engine</td>
<td>High (Windows Server + Excel licenses)</td>
</tr>
<tr>
<td><strong>Third-party Libraries</strong> (openpyxl, xlwings)</td>
<td>Medium - Python code</td>
<td>High - Must duplicate ALL formulas in code</td>
<td>Any OS</td>
<td><strong>No formula execution</strong></td>
<td>Medium (library licenses)</td>
</tr>
<tr>
<td><strong>Rebuild in Code</strong></td>
<td>Very High - Replicate all Excel logic</td>
<td>Very High - Code changes for every formula update</td>
<td>Any OS</td>
<td>Custom implementation</td>
<td>High (development time)</td>
</tr>
<tr>
<td><strong>Excel Online Automation</strong></td>
<td>Medium - Selenium/browser automation</td>
<td>High - Brittle, breaks with UI changes</td>
<td>Browser automation infrastructure</td>
<td>Native Excel engine</td>
<td>Medium (infrastructure)</td>
</tr>
</tbody>
</table>
<h3 id="key-advantages-of-graph-api-approach">Key Advantages of Graph API Approach</h3>
<ol>
<li><strong>No Excel Installation Required</strong></li>
<li>Runs on any OS (Linux, macOS, Windows)</li>
<li>No licensing costs for Excel on servers</li>
<li>
<p>Cloud-native architecture</p>
</li>
<li>
<p><strong>Reuse Existing Excel Logic</strong></p>
</li>
<li>Subject matter experts (engineers, finance teams) maintain formulas in Excel</li>
<li>Developers don't need to understand complex business logic</li>
<li>
<p>Changes to formulas don't require code changes</p>
</li>
<li>
<p><strong>Formula Execution Without Code</strong></p>
</li>
<li>Excel's native calculation engine handles all formulas</li>
<li>VLOOKUPs, array formulas, charts automatically recalculate</li>
<li>
<p>No risk of formula logic discrepancies</p>
</li>
<li>
<p><strong>Scalable &amp; Secure</strong></p>
</li>
<li>Azure AD authentication</li>
<li>Role-based access control</li>
<li>Audit logging built-in</li>
<li>
<p>Handles concurrent users</p>
</li>
<li>
<p><strong>Simple Deployment</strong></p>
</li>
<li>Deploy to Azure App Service, Docker, or any Python host</li>
<li>No Windows dependencies</li>
<li>Standard REST API calls</li>
</ol>
<h3 id="when-this-approach-is-ideal">When This Approach Is Ideal</h3>
<p> Complex Excel workbooks with intricate formulas
 Business users maintain formulas, developers build interface
 Need web/mobile access to Excel functionality
 Want to avoid duplicating business logic in code
 Cloud-first architecture</p>
<h3 id="when-to-consider-alternatives">When to Consider Alternatives</h3>
<p> Need to execute VBA macros (<code>.xlsm</code> files not supported by Graph API)
 Excel file must remain on local/on-premises servers
 Need offline access (Graph API requires internet connectivity)</p>
<hr />
<h2 id="connecting-to-the-excel-file-on-spo">Connecting to the Excel File on SPO</h2>
<p>The following code sets up the workbook endpoint and session management:</p>
<div class="highlight"><pre><span></span><code><span class="n">DRIVE_ID</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
<span class="n">ITEM_ID</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span>
<span class="n">GRAPH_BASE</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">AZURE_GRAPH_V1</span><span class="si">}</span><span class="s2">drives/</span><span class="si">{</span><span class="n">DRIVE_ID</span><span class="si">}</span><span class="s2">/items/</span><span class="si">{</span><span class="n">ITEM_ID</span><span class="si">}</span><span class="s2">/workbook&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
        <span class="n">h</span><span class="p">[</span><span class="s2">&quot;workbook-session-id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>
    <span class="k">return</span> <span class="n">h</span>
</code></pre></div>
<hr />
<h2 id="creating-and-closing-workbook-sessions">Creating and Closing Workbook Sessions</h2>
<p>Sessions ensure your changes are saved and visible to all users. Always close the session after editing.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">persist</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GRAPH_BASE</span><span class="si">}</span><span class="s2">/createSession&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;persistChanges&quot;</span><span class="p">:</span> <span class="n">persist</span><span class="p">}</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">close_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GRAPH_BASE</span><span class="si">}</span><span class="s2">/closeSession&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">204</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Workbook session closed successfully.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Could not close session cleanly: </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error closing session: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="listing-worksheets-and-charts">Listing Worksheets and Charts</h2>
<p>You can enumerate all worksheets and charts in the workbook:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">list_worksheets</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GRAPH_BASE</span><span class="si">}</span><span class="s2">/worksheets&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="p">[])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">list_charts</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GRAPH_BASE</span><span class="si">}</span><span class="s2">/worksheets(&#39;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&#39;)/charts&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="p">[])</span>
</code></pre></div>
<hr />
<h2 id="injecting-data-into-excel-worksheets">Injecting Data into Excel Worksheets</h2>
<p>You can update any cell in the workbook using the Graph API. This triggers recalculation of formulas, tables, and charts automatically.</p>
<h3 id="cell-update-function">Cell Update Function</h3>
<p>Here's the production code for updating a single cell:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">common.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="s2">&quot;pumpapp&quot;</span><span class="p">,</span> <span class="s2">&quot;/mnt/azure/logs/pumpapp.log&quot;</span><span class="p">)</span>

<span class="n">UNPROCESSED_PATH</span> <span class="o">=</span> <span class="s2">&quot;/mnt/azure/pumpcompare/unprocessed&quot;</span>
<span class="n">PROCESSED_PATH</span> <span class="o">=</span> <span class="s2">&quot;/mnt/azure/pumpcompare/processed&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">workbook_headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate headers for workbook API requests.&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;workbook-session-id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">session_id</span>
    <span class="k">return</span> <span class="n">headers</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_cell</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">cell_address</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update a single cell in the worksheet.</span>

<span class="sd">    Args:</span>
<span class="sd">        token: Access token for Graph API</span>
<span class="sd">        session_id: Active workbook session ID</span>
<span class="sd">        sheet_name: Name of the worksheet (e.g., &quot;Input Screen&quot;)</span>
<span class="sd">        cell_address: Excel cell address (e.g., &quot;B3&quot;)</span>
<span class="sd">        value: Value to write to the cell</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WORKBOOK_BASE</span><span class="si">}</span><span class="s2">/worksheets(&#39;</span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">&#39;)/range(address=&#39;</span><span class="si">{</span><span class="n">cell_address</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="n">value</span><span class="p">]]}</span>  <span class="c1"># Must be a 2D array</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">workbook_headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Updated </span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">!</span><span class="si">{</span><span class="n">cell_address</span><span class="si">}</span><span class="s2"> to &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to update </span><span class="si">{</span><span class="n">sheet_name</span><span class="si">}</span><span class="s2">!</span><span class="si">{</span><span class="n">cell_address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
<h3 id="json-driven-workbook-update">JSON-Driven Workbook Update</h3>
<p>The production system uses JSON files to define what data should be injected into which cells. This is the complete <code>update_workbook</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_filename</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract filename without extension from a path.&quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">filename_without_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">filename_without_ext</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_workbook</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">file_to_process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update workbook cells based on JSON file.</span>

<span class="sd">    The JSON file structure:</span>
<span class="sd">    {</span>
<span class="sd">        &quot;jobPressure&quot;: {&quot;value&quot;: 14, &quot;worksheet&quot;: &quot;Input Screen&quot;, &quot;cell&quot;: &quot;B3&quot;},</span>
<span class="sd">        &quot;driverPower&quot;: {&quot;value&quot;: 3100, &quot;worksheet&quot;: &quot;Input Screen&quot;, &quot;cell&quot;: &quot;B4&quot;},</span>
<span class="sd">        &quot;pumps&quot;: [</span>
<span class="sd">            {</span>
<span class="sd">                &quot;name&quot;: {&quot;value&quot;: &quot;Model-5000 HF&quot;, &quot;worksheet&quot;: &quot;Input Screen&quot;, &quot;cell&quot;: &quot;B13&quot;},</span>
<span class="sd">                &quot;diameter&quot;: {&quot;value&quot;: 4.0, &quot;worksheet&quot;: &quot;Input Screen&quot;, &quot;cell&quot;: &quot;B21&quot;}</span>
<span class="sd">            }</span>
<span class="sd">        ],</span>
<span class="sd">        &quot;emailRecipients&quot;: [&quot;user@example.com&quot;]</span>
<span class="sd">    }</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (graph_files_prefix, email_recipients, email_recipients_bcc)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">graph_files_prefix</span> <span class="o">=</span> <span class="n">extract_filename</span><span class="p">(</span><span class="n">file_to_process</span><span class="p">)</span>

        <span class="c1"># Load JSON file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UNPROCESSED_PATH</span><span class="p">,</span> <span class="n">file_to_process</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Extract email arrays</span>
        <span class="n">email_recipients</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;emailRecipients&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">email_recipients_bcc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;emailRecipientsbcc&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Process global parameters (excluding email fields and pumps)</span>
        <span class="n">global_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jobPressure&#39;</span><span class="p">,</span> <span class="s1">&#39;driverPower&#39;</span><span class="p">,</span> <span class="s1">&#39;fleetSize&#39;</span><span class="p">,</span> <span class="s1">&#39;pumpUsage&#39;</span><span class="p">,</span> <span class="s1">&#39;engineRPM&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">global_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">param_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">param_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">worksheet</span> <span class="o">=</span> <span class="n">param_data</span><span class="p">[</span><span class="s1">&#39;worksheet&#39;</span><span class="p">]</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">param_data</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
                <span class="c1"># Update the cell</span>
                <span class="n">update_cell</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># Process pumps array</span>
        <span class="k">if</span> <span class="s1">&#39;pumps&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pump</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pumps&#39;</span><span class="p">]:</span>
                <span class="c1"># Update pump name</span>
                <span class="n">name_data</span> <span class="o">=</span> <span class="n">pump</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">update_cell</span><span class="p">(</span>
                    <span class="n">token</span><span class="p">,</span>
                    <span class="n">session_id</span><span class="p">,</span>
                    <span class="n">name_data</span><span class="p">[</span><span class="s1">&#39;worksheet&#39;</span><span class="p">],</span>
                    <span class="n">name_data</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">],</span>
                    <span class="n">name_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c1"># Update pump diameter</span>
                <span class="n">diameter_data</span> <span class="o">=</span> <span class="n">pump</span><span class="p">[</span><span class="s1">&#39;diameter&#39;</span><span class="p">]</span>
                <span class="n">update_cell</span><span class="p">(</span>
                    <span class="n">token</span><span class="p">,</span>
                    <span class="n">session_id</span><span class="p">,</span>
                    <span class="n">diameter_data</span><span class="p">[</span><span class="s1">&#39;worksheet&#39;</span><span class="p">],</span>
                    <span class="n">diameter_data</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">],</span>
                    <span class="n">diameter_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">graph_files_prefix</span><span class="p">,</span> <span class="n">email_recipients</span><span class="p">,</span> <span class="n">email_recipients_bcc</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update workbook: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
<h3 id="example-json-input-file">Example JSON Input File</h3>
<p>Here's an actual JSON file that gets processed:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;jobPressure&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;B3&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;driverPower&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3100</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;B4&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;fleetSize&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;B5&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;pumpUsage&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;B8&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;engineRPM&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1900</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;B9&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;pumps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Model-5000 HF&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;B13&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;diameter&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">4.0</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;B21&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Kerr EF5&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;D13&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;diameter&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">4.0</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;worksheet&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;cell&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;D21&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;emailRecipients&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;engineer@company.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;manager@company.com&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Key Points:</strong>
- <strong>No Excel installation needed</strong> - Pure REST API calls
- <strong>Formulas recalculate automatically</strong> - Excel's native calculation engine handles all dependencies
- <strong>VLOOKUPs update automatically</strong> - Charts, pivot tables, and formulas refresh after data injection
- <strong>Only <code>.xlsx</code> files supported</strong> - Macro-enabled files (<code>.xlsm</code>) are not editable via Graph API
- <strong>Declarative configuration</strong> - Cell mappings defined in JSON, not hardcoded</p>
<hr />
<h2 id="looping-through-worksheets-and-extracting-charts">Looping Through Worksheets and Extracting Charts</h2>
<p>After updating the workbook, you can loop through all worksheets and extract charts as images:</p>
<div class="highlight"><pre><span></span><code><span class="n">worksheets</span> <span class="o">=</span> <span class="n">list_worksheets</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">worksheets</span><span class="p">:</span>
    <span class="n">ws_name</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">charts</span> <span class="o">=</span> <span class="n">list_charts</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">charts</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No charts found on worksheet &#39;</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charts on &#39;</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">charts</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chart</span> <span class="ow">in</span> <span class="n">charts</span><span class="p">:</span>
        <span class="n">chart_name</span> <span class="o">=</span> <span class="n">chart</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">get_chart_image</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">,</span> <span class="n">chart_name</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROCESSED_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">graph_files_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chart_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Saved chart &#39;</span><span class="si">{</span><span class="n">chart_name</span><span class="si">}</span><span class="s2">&#39; as </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Failed to get chart &#39;</span><span class="si">{</span><span class="n">chart_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Chart Extraction Function:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_chart_image</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">chart_name</span><span class="p">):</span>
    <span class="n">cname</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">chart_name</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">GRAPH_BASE</span><span class="si">}</span><span class="s2">/worksheets(&#39;</span><span class="si">{</span><span class="n">sheet</span><span class="si">}</span><span class="s2">&#39;)/charts(&#39;</span><span class="si">{</span><span class="n">cname</span><span class="si">}</span><span class="s2">&#39;)/image(width=0,height=0,fittingMode=&#39;fit&#39;)&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">b64</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">b64</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="building-the-web-interface-with-flask">Building the Web Interface with Flask</h2>
<p>The production system uses <strong>Flask</strong> to provide a responsive web interface that works on desktop, tablet, and mobile devices. This allows users to input data via a simple form instead of directly editing Excel.</p>
<h3 id="flask-application-setup">Flask Application Setup</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_mapping</span><span class="p">(</span>
    <span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span>
    <span class="n">SESSION_TYPE</span><span class="o">=</span><span class="s1">&#39;filesystem&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Directory configuration</span>
<span class="n">UNPROCESSED_PATH</span> <span class="o">=</span> <span class="s2">&quot;/mnt/azure/pumpcompare/unprocessed&quot;</span>
<span class="n">PROCESSED_PATH</span> <span class="o">=</span> <span class="s2">&quot;/mnt/azure/pumpcompare/processed&quot;</span>
</code></pre></div>
<h3 id="the-pump-comparison-web-route">The Pump Comparison Web Route</h3>
<p>This is the main route that handles both displaying the form (GET) and processing submissions (POST):</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/pump-comparison&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">pump_comparison</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle pump comparison requests.</span>
<span class="sd">    GET: Display form with pump selections</span>
<span class="sd">    POST: Process form, create JSON, trigger Excel automation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># Check if user is returning to form (not processing new request)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;return&#39;</span><span class="p">:</span>
            <span class="c1"># Repopulate form with previous values</span>
            <span class="n">pump_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Dragon DP4000Q&quot;</span><span class="p">,</span> <span class="s2">&quot;FET FXD3500&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-3500&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-3600 HF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Model-5000 HF&quot;</span><span class="p">,</span> <span class="s2">&quot;Kerr EF5&quot;</span><span class="p">,</span> <span class="s2">&quot;Kerr EF5 Lite&quot;</span><span class="p">,</span> <span class="s2">&quot;SPM WS335&quot;</span><span class="p">,</span>
                <span class="s2">&quot;SPM QEM 3600C&quot;</span><span class="p">,</span> <span class="s2">&quot;SPM QEM 5000C&quot;</span><span class="p">,</span> <span class="s2">&quot;AW 2500&quot;</span><span class="p">,</span> <span class="s2">&quot;FET FXD2250&quot;</span><span class="p">,</span>
                <span class="s2">&quot;FET FXD2500&quot;</span><span class="p">,</span> <span class="s2">&quot;FET FXD3000&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-2250T&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-2500Q HDF&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Model-C2500&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-3000&quot;</span><span class="p">,</span> <span class="s2">&quot;SPM EXL&quot;</span><span class="p">,</span> <span class="s2">&quot;VT-2500Q 52IN&quot;</span><span class="p">,</span> <span class="s2">&quot;VT-2500Q 60IN&quot;</span>
            <span class="p">]</span>
            <span class="n">diameters</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
                <span class="n">get_form_template</span><span class="p">(),</span>
                <span class="n">pump_names</span><span class="o">=</span><span class="n">pump_names</span><span class="p">,</span>
                <span class="n">diameters</span><span class="o">=</span><span class="n">diameters</span><span class="p">,</span>
                <span class="n">error_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">form_data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span>
            <span class="p">)</span>

        <span class="c1"># Validate that at least 2 pumps are selected</span>
        <span class="n">selected_pumps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">pump_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pump</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">pump_diameter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pump</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_diameter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pump_name</span> <span class="ow">and</span> <span class="n">pump_diameter</span><span class="p">:</span>
                <span class="n">selected_pumps</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">selected_pumps</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Please select at least 2 pumps for comparison.&quot;</span>
            <span class="c1"># Redisplay form with error</span>
            <span class="n">pump_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Dragon DP4000Q&quot;</span><span class="p">,</span> <span class="s2">&quot;FET FXD3500&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>  <span class="c1"># Full list</span>
            <span class="n">diameters</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
                <span class="n">get_form_template</span><span class="p">(),</span>
                <span class="n">pump_names</span><span class="o">=</span><span class="n">pump_names</span><span class="p">,</span>
                <span class="n">diameters</span><span class="o">=</span><span class="n">diameters</span><span class="p">,</span>
                <span class="n">error_message</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
                <span class="n">form_data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span>
            <span class="p">)</span>

        <span class="c1"># Build JSON structure from form data</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;jobPressure&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jobPressure&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s2">&quot;worksheet&quot;</span><span class="p">:</span> <span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="s2">&quot;B3&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;driverPower&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;driverPower&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s2">&quot;worksheet&quot;</span><span class="p">:</span> <span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="s2">&quot;B4&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;fleetSize&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fleetSize&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s2">&quot;worksheet&quot;</span><span class="p">:</span> <span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="s2">&quot;B5&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;pumpUsage&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pumpUsage&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s2">&quot;worksheet&quot;</span><span class="p">:</span> <span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="s2">&quot;B8&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;engineRPM&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;engineRPM&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
                <span class="s2">&quot;worksheet&quot;</span><span class="p">:</span> <span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="s2">&quot;B9&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;emailRecipients&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;pumps&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="c1"># Define cell mappings for 4 pumps</span>
        <span class="n">pump_cells</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;B13&quot;</span><span class="p">,</span> <span class="s2">&quot;diameter&quot;</span><span class="p">:</span> <span class="s2">&quot;B21&quot;</span><span class="p">},</span>
            <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;D13&quot;</span><span class="p">,</span> <span class="s2">&quot;diameter&quot;</span><span class="p">:</span> <span class="s2">&quot;D21&quot;</span><span class="p">},</span>
            <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;F13&quot;</span><span class="p">,</span> <span class="s2">&quot;diameter&quot;</span><span class="p">:</span> <span class="s2">&quot;F21&quot;</span><span class="p">},</span>
            <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;H13&quot;</span><span class="p">,</span> <span class="s2">&quot;diameter&quot;</span><span class="p">:</span> <span class="s2">&quot;H21&quot;</span><span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># Process all 4 pumps (empty strings for unselected pumps)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
            <span class="n">pump_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pump</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">pump_diameter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;pump</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_diameter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Convert diameter to float if it exists, otherwise empty string</span>
            <span class="n">diameter_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pump_diameter</span><span class="p">)</span> <span class="k">if</span> <span class="n">pump_diameter</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

            <span class="n">pump_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">pump_name</span> <span class="k">if</span> <span class="n">pump_name</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;worksheet&quot;</span><span class="p">:</span> <span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="n">pump_cells</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s2">&quot;diameter&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">diameter_value</span><span class="p">,</span>
                    <span class="s2">&quot;worksheet&quot;</span><span class="p">:</span> <span class="s2">&quot;Input Screen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cell&quot;</span><span class="p">:</span> <span class="n">pump_cells</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;diameter&quot;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">json_data</span><span class="p">[</span><span class="s2">&quot;pumps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pump_data</span><span class="p">)</span>

        <span class="c1"># Create filename with timestamp</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M%S</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pump_comparison_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.json&quot;</span>

        <span class="c1"># Define file path</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UNPROCESSED_PATH</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Ensure directory exists</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Write JSON file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Sleep briefly to ensure file is on storage account</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Trigger the Excel automation process</span>
        <span class="n">chart_files</span> <span class="o">=</span> <span class="n">process_pump_comparison_requests</span><span class="p">()</span>

        <span class="c1"># Construct the PDF filename</span>
        <span class="n">pdf_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_Pump_Comparison.pdf&quot;</span>

        <span class="c1"># Return success page with charts</span>
        <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
            <span class="n">get_success_template</span><span class="p">(),</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
            <span class="n">pdf_filename</span><span class="o">=</span><span class="n">pdf_filename</span><span class="p">,</span>
            <span class="n">form_data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="n">chart_files</span><span class="o">=</span><span class="n">chart_files</span>
        <span class="p">)</span>

    <span class="c1"># GET method - Display the form with default values</span>
    <span class="n">pump_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Dragon DP4000Q&quot;</span><span class="p">,</span> <span class="s2">&quot;FET FXD3500&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-3500&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-3600 HF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Model-5000 HF&quot;</span><span class="p">,</span> <span class="s2">&quot;Kerr EF5&quot;</span><span class="p">,</span> <span class="s2">&quot;Kerr EF5 Lite&quot;</span><span class="p">,</span> <span class="s2">&quot;SPM WS335&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SPM QEM 3600C&quot;</span><span class="p">,</span> <span class="s2">&quot;SPM QEM 5000C&quot;</span><span class="p">,</span> <span class="s2">&quot;AW 2500&quot;</span><span class="p">,</span> <span class="s2">&quot;FET FXD2250&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FET FXD2500&quot;</span><span class="p">,</span> <span class="s2">&quot;FET FXD3000&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-2250T&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-2500Q HDF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Model-C2500&quot;</span><span class="p">,</span> <span class="s2">&quot;Model-3000&quot;</span><span class="p">,</span> <span class="s2">&quot;SPM EXL&quot;</span><span class="p">,</span> <span class="s2">&quot;VT-2500Q 52IN&quot;</span><span class="p">,</span> <span class="s2">&quot;VT-2500Q 60IN&quot;</span>
    <span class="p">]</span>
    <span class="n">diameters</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>

    <span class="c1"># Set default values</span>
    <span class="n">default_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;jobPressure&#39;</span><span class="p">:</span> <span class="s1">&#39;14&#39;</span><span class="p">,</span>
        <span class="s1">&#39;driverPower&#39;</span><span class="p">:</span> <span class="s1">&#39;3100&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fleetSize&#39;</span><span class="p">:</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pumpUsage&#39;</span><span class="p">:</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
        <span class="s1">&#39;engineRPM&#39;</span><span class="p">:</span> <span class="s1">&#39;1900&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pump1_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Model-5000 HF&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pump1_diameter&#39;</span><span class="p">:</span> <span class="s1">&#39;4.0&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pump2_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Kerr EF5&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pump2_diameter&#39;</span><span class="p">:</span> <span class="s1">&#39;4.0&#39;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
        <span class="n">get_form_template</span><span class="p">(),</span>
        <span class="n">pump_names</span><span class="o">=</span><span class="n">pump_names</span><span class="p">,</span>
        <span class="n">diameters</span><span class="o">=</span><span class="n">diameters</span><span class="p">,</span>
        <span class="n">error_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">form_data</span><span class="o">=</span><span class="n">default_data</span>
    <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</code></pre></div>
<h3 id="key-features-of-the-web-interface">Key Features of the Web Interface</h3>
<ol>
<li><strong>Responsive Design</strong>: Works on desktop, tablet (iPad optimized), and mobile devices</li>
<li><strong>Client-Side Validation</strong>: JavaScript ensures at least 2 pumps are selected</li>
<li><strong>Server-Side Validation</strong>: Python validates data before processing</li>
<li><strong>Default Values</strong>: Pre-populated sensible defaults for quick testing</li>
<li><strong>Error Handling</strong>: Clear error messages guide users</li>
<li><strong>Progress Feedback</strong>: Users see their input parameters and generated charts</li>
</ol>
<h3 id="html-form-template">HTML Form Template</h3>
<p>The form template is embedded in the Python code using Jinja2 templating. Here's an excerpt showing the structure:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_form_template</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;!doctype html&gt;</span>
<span class="s2">    &lt;html lang=&quot;en&quot;&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;meta charset=&quot;UTF-8&quot;&gt;</span>
<span class="s2">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, user-scalable=no&quot;&gt;</span>
<span class="s2">        &lt;title&gt;Pump Comparison&lt;/title&gt;</span>
<span class="s2">        &lt;style&gt;</span>
<span class="s2">            /* Modern, responsive CSS */</span>
<span class="s2">            body { font-family: -apple-system, BlinkMacSystemFont, &#39;Segoe UI&#39;, Roboto; }</span>
<span class="s2">            .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }</span>
<span class="s2">            input[type=&quot;number&quot;], select {</span>
<span class="s2">                width: 100%;</span>
<span class="s2">                padding: 12px;</span>
<span class="s2">                border: 2px solid #ddd;</span>
<span class="s2">                border-radius: 8px;</span>
<span class="s2">                min-height: 44px;  /* iPad touch target */</span>
<span class="s2">            }</span>
<span class="s2">            /* Mobile responsive */</span>
<span class="s2">            @media (max-width: 767px) {</span>
<span class="s2">                .form-grid { grid-template-columns: 1fr; }</span>
<span class="s2">            }</span>
<span class="s2">        &lt;/style&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;h1&gt;Pump Comparison Tool&lt;/h1&gt;</span>
<span class="s2">        &lt;form method=&quot;POST&quot;&gt;</span>
<span class="s2">            {</span><span class="si">% i</span><span class="s2">f error_message %}</span>
<span class="s2">            &lt;div class=&quot;error-message&quot;&gt;{{ error_message }}&lt;/div&gt;</span>
<span class="s2">            {</span><span class="si">% e</span><span class="s2">ndif %}</span>

<span class="s2">            &lt;!-- Global Parameters Section --&gt;</span>
<span class="s2">            &lt;div class=&quot;section&quot;&gt;</span>
<span class="s2">                &lt;h2&gt;Global Parameters&lt;/h2&gt;</span>
<span class="s2">                &lt;div class=&quot;form-grid&quot;&gt;</span>
<span class="s2">                    &lt;div class=&quot;form-group&quot;&gt;</span>
<span class="s2">                        &lt;label for=&quot;jobPressure&quot;&gt;Job Pressure (1-20)&lt;/label&gt;</span>
<span class="s2">                        &lt;input type=&quot;number&quot; name=&quot;jobPressure&quot; min=&quot;1&quot; max=&quot;20&quot;</span>
<span class="s2">                               value=&quot;{{ form_data.get(&#39;jobPressure&#39;, &#39;14&#39;) }}&quot; required&gt;</span>
<span class="s2">                    &lt;/div&gt;</span>
<span class="s2">                    &lt;!-- Additional fields... --&gt;</span>
<span class="s2">                &lt;/div&gt;</span>
<span class="s2">            &lt;/div&gt;</span>

<span class="s2">            &lt;!-- Pump Selection Section --&gt;</span>
<span class="s2">            &lt;div class=&quot;section&quot;&gt;</span>
<span class="s2">                &lt;h2&gt;Pump Comparison&lt;/h2&gt;</span>
<span class="s2">                {</span><span class="si">% f</span><span class="s2">or i in range(1, 5) %}</span>
<span class="s2">                &lt;div class=&quot;pump-card&quot;&gt;</span>
<span class="s2">                    &lt;div class=&quot;pump-header&quot;&gt;Pump {{ i }}&lt;/div&gt;</span>
<span class="s2">                    &lt;select name=&quot;pump{{ i }}_name&quot; {</span><span class="si">% i</span><span class="s2">f i &lt;= 2 %}required{</span><span class="si">% e</span><span class="s2">ndif %}&gt;</span>
<span class="s2">                        &lt;option value=&quot;&quot;&gt;-- Select Pump --&lt;/option&gt;</span>
<span class="s2">                        {</span><span class="si">% f</span><span class="s2">or pump in pump_names %}</span>
<span class="s2">                        &lt;option value=&quot;{{ pump }}&quot;&gt;{{ pump }}&lt;/option&gt;</span>
<span class="s2">                        {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">                    &lt;/select&gt;</span>
<span class="s2">                    &lt;select name=&quot;pump{{ i }}_diameter&quot; {</span><span class="si">% i</span><span class="s2">f i &lt;= 2 %}required{</span><span class="si">% e</span><span class="s2">ndif %}&gt;</span>
<span class="s2">                        {</span><span class="si">% f</span><span class="s2">or diameter in diameters %}</span>
<span class="s2">                        &lt;option value=&quot;{{ diameter }}&quot;&gt;{{ diameter }}&lt;/option&gt;</span>
<span class="s2">                        {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">                    &lt;/select&gt;</span>
<span class="s2">                &lt;/div&gt;</span>
<span class="s2">                {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2">            &lt;/div&gt;</span>

<span class="s2">            &lt;input type=&quot;submit&quot; value=&quot;Generate Comparison&quot;&gt;</span>
<span class="s2">        &lt;/form&gt;</span>

<span class="s2">        &lt;script&gt;</span>
<span class="s2">            // Client-side validation</span>
<span class="s2">            document.querySelector(&#39;form&#39;).addEventListener(&#39;submit&#39;, function(e) {</span>
<span class="s2">                let selectedCount = 0;</span>
<span class="s2">                for (let i = 1; i &lt;= 4; i++) {</span>
<span class="s2">                    const name = document.getElementById(&#39;pump&#39; + i + &#39;_name&#39;).value;</span>
<span class="s2">                    const diameter = document.getElementById(&#39;pump&#39; + i + &#39;_diameter&#39;).value;</span>
<span class="s2">                    if (name &amp;&amp; diameter) selectedCount++;</span>
<span class="s2">                }</span>
<span class="s2">                if (selectedCount &lt; 2) {</span>
<span class="s2">                    e.preventDefault();</span>
<span class="s2">                    alert(&#39;Please select at least 2 pumps for comparison.&#39;);</span>
<span class="s2">                }</span>
<span class="s2">            });</span>
<span class="s2">        &lt;/script&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
</code></pre></div>
<hr />
<h2 id="end-to-end-workflow-example">End-to-End Workflow Example</h2>
<p>Here is a simplified workflow for processing pump comparison requests:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_pump_comparison_requests</span><span class="p">():</span>
    <span class="n">unprocessed_files</span> <span class="o">=</span> <span class="n">fetch_unprocessed_pump_comparisons_requests</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">unprocessed_file</span> <span class="ow">in</span> <span class="n">unprocessed_files</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">get_access_token_API_Access_AAD</span><span class="p">()</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">graph_files_prefix</span><span class="p">,</span> <span class="n">email_recipients</span><span class="p">,</span> <span class="n">email_recipients_bcc</span> <span class="o">=</span> <span class="n">update_workbook</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">unprocessed_file</span><span class="p">)</span>
        <span class="n">OUTPUT_PDF</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROCESSED_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">graph_files_prefix</span><span class="si">}</span><span class="s2">_Pump_Comparison.pdf&quot;</span><span class="p">)</span>
        <span class="n">worksheets</span> <span class="o">=</span> <span class="n">list_worksheets</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Worksheets found:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">ws</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">worksheets</span><span class="p">])</span>
        <span class="c1"># Loop through worksheets and extract charts</span>
        <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">worksheets</span><span class="p">:</span>
            <span class="n">ws_name</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">charts</span> <span class="o">=</span> <span class="n">list_charts</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">charts</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No charts found on worksheet &#39;</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charts on &#39;</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">charts</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chart</span> <span class="ow">in</span> <span class="n">charts</span><span class="p">:</span>
                <span class="n">chart_name</span> <span class="o">=</span> <span class="n">chart</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">get_chart_image</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">,</span> <span class="n">chart_name</span><span class="p">)</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROCESSED_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">graph_files_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chart_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Saved chart &#39;</span><span class="si">{</span><span class="n">chart_name</span><span class="si">}</span><span class="s2">&#39; as </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Failed to get chart &#39;</span><span class="si">{</span><span class="n">chart_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">close_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="generating-professional-pdf-reports-with-reportlab">Generating Professional PDF Reports with ReportLab</h2>
<p>After updating the Excel file and extracting charts, the production system generates a professional PDF report combining the input parameters table with all refreshed charts.</p>
<h3 id="complete-pdf-generation-code">Complete PDF Generation Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib.pagesizes</span><span class="w"> </span><span class="kn">import</span> <span class="n">letter</span><span class="p">,</span> <span class="n">landscape</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.platypus</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleDocTemplate</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">TableStyle</span><span class="p">,</span> <span class="n">Paragraph</span><span class="p">,</span> <span class="n">Spacer</span><span class="p">,</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">reportlab.lib.styles</span><span class="w"> </span><span class="kn">import</span> <span class="n">getSampleStyleSheet</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_pump_comparison_pdf</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">workbook_base</span><span class="p">,</span> <span class="n">chart_files</span><span class="p">,</span> <span class="n">output_pdf_path</span><span class="p">,</span> <span class="n">graph_files_prefix</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a comprehensive PDF report with input parameters and charts.</span>

<span class="sd">    Args:</span>
<span class="sd">        token: Access token</span>
<span class="sd">        session_id: Workbook session ID</span>
<span class="sd">        workbook_base: Base URL for workbook</span>
<span class="sd">        chart_files: List of chart file paths</span>
<span class="sd">        output_pdf_path: Path where PDF should be saved</span>
<span class="sd">        graph_files_prefix: Prefix for naming</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Fetch the &quot;Input screen&quot; worksheet data from Excel</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workbook_base</span><span class="si">}</span><span class="s2">/worksheets(&#39;Input screen&#39;)/usedRange(valuesOnly=true)&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">workbook_headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>  <span class="c1"># Returns 2D array</span>

    <span class="c1"># Create PDF document with landscape layout</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">SimpleDocTemplate</span><span class="p">(</span>
        <span class="n">output_pdf_path</span><span class="p">,</span>
        <span class="n">pagesize</span><span class="o">=</span><span class="n">landscape</span><span class="p">(</span><span class="n">letter</span><span class="p">),</span>
        <span class="n">leftMargin</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">rightMargin</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">topMargin</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">bottomMargin</span><span class="o">=</span><span class="mi">6</span>
    <span class="p">)</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="n">getSampleStyleSheet</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="c1"># Add company logo</span>
        <span class="n">workspace_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;../&#39;</span><span class="p">))</span>
        <span class="n">logo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">workspace_root</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="s1">&#39;logo.png&#39;</span><span class="p">)</span>
        <span class="n">logo</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">logo_path</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Create header with title and logo</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">Paragraph</span><span class="p">(</span><span class="s2">&quot;Input Parameters (Pump Comparisons)&quot;</span><span class="p">,</span> <span class="n">styles</span><span class="p">[</span><span class="s1">&#39;Heading1&#39;</span><span class="p">])</span>
        <span class="n">header_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([[</span><span class="n">title</span><span class="p">,</span> <span class="n">logo</span><span class="p">]],</span> <span class="n">colWidths</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="mi">140</span><span class="p">])</span>
        <span class="n">header_table</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">TableStyle</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">&#39;VALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;TOP&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;RIGHT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;LEFTPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RIGHTPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TOPPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BOTTOMPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">]))</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_table</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

        <span class="c1"># Clean up rows 0 and 9 (section headers - span across all columns)</span>
        <span class="n">num_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">row_idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">row_idx</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">row_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">row_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create input parameters table</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">table_style</span> <span class="o">=</span> <span class="n">TableStyle</span><span class="p">([</span>
            <span class="c1"># General formatting</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;Helvetica&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTSIZE&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;VALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;MIDDLE&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;LEFTPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">6</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;RIGHTPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">6</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;TOPPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BOTTOMPADDING&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">),</span>

            <span class="c1"># Rows 10-11: Pump comparison header (bold, green background)</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="s1">&#39;Helvetica-Bold&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="n">colors</span><span class="o">.</span><span class="n">lightgreen</span><span class="p">),</span>

            <span class="c1"># Row 0: Main title (span all columns, left align, bold)</span>
            <span class="p">(</span><span class="s1">&#39;SPAN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;LEFT&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Helvetica-Bold&#39;</span><span class="p">),</span>

            <span class="c1"># Row 9: Section header (span all columns, center align, bold)</span>
            <span class="p">(</span><span class="s1">&#39;SPAN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="s1">&#39;CENTER&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;FONTNAME&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="s1">&#39;Helvetica-Bold&#39;</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="n">table</span><span class="o">.</span><span class="n">setStyle</span><span class="p">(</span><span class="n">table_style</span><span class="p">)</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="c1"># Add all charts to subsequent pages</span>
    <span class="n">chart_files_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chart_files</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="n">chart_files_sorted</span><span class="p">:</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Spacer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">400</span><span class="p">))</span>

    <span class="c1"># Build the PDF</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF created with worksheet + charts: </span><span class="si">{</span><span class="n">output_pdf_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_pdf_path</span>
</code></pre></div>
<h3 id="integrating-pdf-generation-into-the-workflow">Integrating PDF Generation into the Workflow</h3>
<p>The PDF generation is called after all charts are extracted:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process_pump_comparison_requests</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main processing function that orchestrates the entire workflow.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">chart_files_for_all_requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unprocessed_files</span> <span class="o">=</span> <span class="n">fetch_unprocessed_pump_comparisons_requests</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">unprocessed_file</span> <span class="ow">in</span> <span class="n">unprocessed_files</span><span class="p">:</span>
            <span class="c1"># Authenticate and create session</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">get_access_token_API_Access_AAD</span><span class="p">()</span>
            <span class="n">session_id</span> <span class="o">=</span> <span class="n">create_workbook_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">pump_comparison_workbook_base</span><span class="p">)</span>

            <span class="c1"># Update workbook with JSON data</span>
            <span class="n">graph_files_prefix</span><span class="p">,</span> <span class="n">email_recipients</span><span class="p">,</span> <span class="n">email_recipients_bcc</span> <span class="o">=</span> <span class="n">update_workbook</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">unprocessed_file</span>
            <span class="p">)</span>

            <span class="n">OUTPUT_PDF</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROCESSED_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">graph_files_prefix</span><span class="si">}</span><span class="s2">_Pump_Comparison.pdf&quot;</span><span class="p">)</span>

            <span class="c1"># List worksheets</span>
            <span class="n">worksheets</span> <span class="o">=</span> <span class="n">list_worksheets</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">pump_comparison_workbook_base</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worksheets found: </span><span class="si">{</span><span class="p">[</span><span class="n">ws</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ws</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">worksheets</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">chart_files_this_request</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Loop through each worksheet and extract charts</span>
            <span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="n">worksheets</span><span class="p">:</span>
                <span class="n">ws_name</span> <span class="o">=</span> <span class="n">ws</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">charts</span> <span class="o">=</span> <span class="n">list_charts</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">pump_comparison_workbook_base</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">charts</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No charts found on worksheet &#39;</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Charts on &#39;</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">charts</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">chart</span> <span class="ow">in</span> <span class="n">charts</span><span class="p">:</span>
                    <span class="n">chart_name</span> <span class="o">=</span> <span class="n">chart</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">get_chart_image</span><span class="p">(</span>
                            <span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">pump_comparison_workbook_base</span><span class="p">,</span> <span class="n">ws_name</span><span class="p">,</span> <span class="n">chart_name</span>
                        <span class="p">)</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">PROCESSED_PATH</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">graph_files_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ws_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">chart_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.png&quot;</span>
                        <span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">)</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Saved chart &#39;</span><span class="si">{</span><span class="n">chart_name</span><span class="si">}</span><span class="s2">&#39; as </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">chart_files_this_request</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Failed to get chart &#39;</span><span class="si">{</span><span class="n">chart_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Generate the PDF report</span>
            <span class="n">generate_pump_comparison_pdf</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="n">session_id</span><span class="p">,</span>
                <span class="n">pump_comparison_workbook_base</span><span class="p">,</span>
                <span class="n">chart_files_this_request</span><span class="p">,</span>
                <span class="n">OUTPUT_PDF</span><span class="p">,</span>
                <span class="n">graph_files_prefix</span>
            <span class="p">)</span>

            <span class="c1"># Close workbook session</span>
            <span class="n">close_workbook_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">pump_comparison_workbook_base</span><span class="p">)</span>

            <span class="c1"># Move processed file</span>
            <span class="n">src_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UNPROCESSED_PATH</span><span class="p">,</span> <span class="n">unprocessed_file</span><span class="p">)</span>
            <span class="n">dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROCESSED_PATH</span><span class="p">,</span> <span class="n">unprocessed_file</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">)</span>

            <span class="n">chart_files_for_all_requests</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chart_files_this_request</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chart_files_for_all_requests</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
<h3 id="key-pdf-features">Key PDF Features</h3>
<ol>
<li><strong>Professional Layout</strong></li>
<li>Landscape orientation for wide tables</li>
<li>Company logo in header</li>
<li>
<p>Consistent styling and spacing</p>
</li>
<li>
<p><strong>Dynamic Table Rendering</strong></p>
</li>
<li>Automatically adapts to Excel data structure</li>
<li>Conditional formatting (bold headers, colored backgrounds)</li>
<li>
<p>Proper cell spanning for section headers</p>
</li>
<li>
<p><strong>Chart Integration</strong></p>
</li>
<li>High-quality PNG images from Excel</li>
<li>Optimal sizing (700x400 pixels)</li>
<li>
<p>Sorted display order</p>
</li>
<li>
<p><strong>Production-Ready</strong></p>
</li>
<li>Error handling and logging</li>
<li>File path management</li>
<li>Memory-efficient processing</li>
</ol>
<hr />
<h2 id="email-automation-delivering-reports-to-recipients">Email Automation: Delivering Reports to Recipients</h2>
<p>The final step in the workflow is automatically emailing the PDF report to specified recipients. The production system includes both automatic and user-triggered email sending.</p>
<h3 id="email-sending-function">Email Sending Function</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">common.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">send_email</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_pump_comparison_email</span><span class="p">(</span><span class="n">customer_name</span><span class="p">,</span> <span class="n">email_recipients</span><span class="p">,</span> <span class="n">pdf_attachment_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send an HTML formatted email with pump comparison PDF attachment.</span>

<span class="sd">    Args:</span>
<span class="sd">        customer_name: Name of the customer/requester</span>
<span class="sd">        email_recipients: List of email addresses</span>
<span class="sd">        pdf_attachment_path: Full path to the PDF file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Pump Comparison Summary&quot;</span>

        <span class="n">body</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">        &lt;body style=&quot;font-family:verdana,courier,serif; font-size: 13px;&quot;&gt;</span>
<span class="s2">            &lt;p&gt;Thank you for requesting the pump comparisons summary.&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Attached please find the PDF document with the detailed pump comparisons.&lt;/p&gt;</span>
<span class="s2">            &lt;br&gt;&lt;br&gt;&lt;b&gt;**This is an automated message please do not reply**&lt;/b&gt;&lt;br&gt;</span>
<span class="s2">        &lt;/body&gt;</span>
<span class="s2">        &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">send_email</span><span class="p">(</span>
            <span class="n">recipients</span><span class="o">=</span><span class="n">email_recipients</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">html_message</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
            <span class="n">attachments</span><span class="o">=</span><span class="p">[</span><span class="n">pdf_attachment_path</span><span class="p">],</span>
            <span class="n">bcc</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;admin@company.com&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Email sent successfully to </span><span class="si">{</span><span class="n">email_recipients</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send email: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
<h3 id="flask-route-for-user-triggered-email-sending">Flask Route for User-Triggered Email Sending</h3>
<p>The web application allows users to send the PDF report via email after reviewing the results:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/send-pump-comparison-email&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_pump_comparison_email_route</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle email sending requests from the results page.</span>
<span class="sd">    Users can specify recipient email addresses and trigger sending.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parse email addresses from form (semicolon-separated)</span>
        <span class="n">customer_emails_raw</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;customerEmails&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">email_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">customer_emails_raw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">email</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

        <span class="n">pdf_filename</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Construct PDF file path</span>
        <span class="n">pdf_path_processed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s2">&quot;/mnt/azure/pumpcompare/processed&quot;</span><span class="p">,</span>
            <span class="n">pdf_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Verify PDF exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdf_path_processed</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;PDF file not found: </span><span class="si">{</span><span class="n">pdf_filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">}),</span> <span class="mi">404</span>

        <span class="c1"># Send the email</span>
        <span class="n">send_pump_comparison_email</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">email_list</span><span class="p">,</span> <span class="n">pdf_path_processed</span><span class="p">)</span>

        <span class="c1"># Return success response and redirect back to results</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Email sent successfully!&quot;</span>
        <span class="p">}),</span> <span class="mi">200</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error sending email: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div>
<h3 id="email-form-in-results-page">Email Form in Results Page</h3>
<p>The results page includes an email form where users can specify recipients:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/send-pump-comparison-email&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;filename&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{ pdf_filename }}&quot;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;customerEmails&quot;</span><span class="p">&gt;</span>Customer Email(s) (Required)<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span>
           <span class="na">name</span><span class="o">=</span><span class="s">&quot;customerEmails&quot;</span>
           <span class="na">id</span><span class="o">=</span><span class="s">&quot;customerEmails&quot;</span>
           <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;email1@example.com; email2@example.com&quot;</span>
           <span class="na">required</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;email-hint&quot;</span><span class="p">&gt;</span>
        Separate multiple emails with semicolons (;)
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">&gt;</span>Send Email<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="email-integration-options">Email Integration Options</h3>
<p>The production system supports multiple email delivery methods:</p>
<ol>
<li><strong>Direct SMTP</strong> - Using Python's <code>smtplib</code> library</li>
<li><strong>Microsoft Graph API</strong> - Leveraging Office 365 Send Mail endpoint</li>
<li><strong>SendGrid/Mailgun</strong> - Third-party email services</li>
</ol>
<p><strong>Example: Microsoft Graph API Email Sending</strong></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_email_via_graph</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">html_body</span><span class="p">,</span> <span class="n">attachments</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send email using Microsoft Graph API.&quot;&quot;&quot;</span>

    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://graph.microsoft.com/v1.0/me/sendMail&quot;</span>

    <span class="c1"># Build message payload</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span>
            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;contentType&quot;</span><span class="p">:</span> <span class="s2">&quot;HTML&quot;</span><span class="p">,</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">html_body</span>
            <span class="p">},</span>
            <span class="s2">&quot;toRecipients&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;emailAddress&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">}}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">],</span>
            <span class="s2">&quot;attachments&quot;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># Add PDF attachment (base64 encoded)</span>
    <span class="k">for</span> <span class="n">attachment_path</span> <span class="ow">in</span> <span class="n">attachments</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">attachment_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">file_content</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">][</span><span class="s2">&quot;attachments&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;@odata.type&quot;</span><span class="p">:</span> <span class="s2">&quot;#microsoft.graph.fileAttachment&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">attachment_path</span><span class="p">),</span>
            <span class="s2">&quot;contentType&quot;</span><span class="p">:</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;contentBytes&quot;</span><span class="p">:</span> <span class="n">file_content</span>
        <span class="p">})</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">202</span>  <span class="c1"># Accepted</span>
</code></pre></div>
<h3 id="key-email-features">Key Email Features</h3>
<ol>
<li><strong>HTML Formatting</strong> - Professional, branded email templates</li>
<li><strong>Multiple Recipients</strong> - Semicolon-separated email list</li>
<li><strong>PDF Attachments</strong> - Automatically attach generated reports</li>
<li><strong>BCC Support</strong> - Copy management/audit addresses</li>
<li><strong>Error Handling</strong> - Graceful failure with user notification</li>
<li><strong>Audit Logging</strong> - Track all email sending activities</li>
</ol>
<h2 id="production-considerations-performance-security-and-error-handling">Production Considerations: Performance, Security, and Error Handling</h2>
<h3 id="performance-optimization">Performance Optimization</h3>
<p><strong>1. Access Token Caching</strong></p>
<p>Avoid acquiring a new token for every request. Cache and reuse tokens until expiration:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Token cache with expiration check</span>
<span class="n">token_cache</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_cached_access_token</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get access token with caching to reduce auth overhead.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">token_cache</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">current_time</span> <span class="o">&lt;</span> <span class="n">token_cache</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">token_cache</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span>

    <span class="c1"># Token expired or doesn&#39;t exist, acquire new one</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">get_access_token_API_Access_AAD</span><span class="p">()</span>

    <span class="c1"># Cache for 50 minutes (tokens typically valid for 60 minutes)</span>
    <span class="n">token_cache</span><span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
    <span class="n">token_cache</span><span class="p">[</span><span class="s2">&quot;expires_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_time</span> <span class="o">+</span> <span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">token</span>
</code></pre></div>
<p><strong>2. Session Management Best Practices</strong></p>
<p>Always close workbook sessions to free server resources:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">safe_workbook_operation</span><span class="p">(</span><span class="n">workbook_base</span><span class="p">,</span> <span class="n">operation_func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute workbook operation with guaranteed session cleanup.&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">get_cached_access_token</span><span class="p">()</span>
    <span class="n">session_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">session_id</span> <span class="o">=</span> <span class="n">create_workbook_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">workbook_base</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">operation_func</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">session_id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">close_workbook_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">workbook_base</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to close session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>3. Batch Updates for Large Datasets</strong></p>
<p>When updating many cells, batch operations reduce API calls:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">batch_update_cells</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update multiple cells in a single API call.</span>

<span class="sd">    updates = [</span>
<span class="sd">        {&quot;cell&quot;: &quot;A1&quot;, &quot;value&quot;: 100},</span>
<span class="sd">        {&quot;cell&quot;: &quot;B1&quot;, &quot;value&quot;: 200},</span>
<span class="sd">        ...</span>
<span class="sd">    ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the range that encompasses all cells</span>
    <span class="c1"># Then update the entire range in one call</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WORKBOOK_BASE</span><span class="si">}</span><span class="s2">/worksheets(&#39;</span><span class="si">{</span><span class="n">worksheet</span><span class="si">}</span><span class="s2">&#39;)/range(address=&#39;A1:Z100&#39;)&quot;</span>

    <span class="c1"># Build 2D array for bulk update</span>
    <span class="c1"># ... implementation details</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">workbook_headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</code></pre></div>
<p><strong>4. File Cleanup Strategy</strong></p>
<p>Prevent disk space issues with automatic cleanup:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cleanup_old_files</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">max_age_days</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove files older than max_age_days.&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_age_days</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;logo.png&#39;</span><span class="p">:</span>  <span class="c1"># Preserve static assets</span>
            <span class="k">continue</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mtime</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Deleted old file: </span><span class="si">{</span><span class="n">fpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Error deleting file </span><span class="si">{</span><span class="n">fpath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="security-considerations">Security Considerations</h3>
<p><strong>1. Certificate-Based Authentication</strong></p>
<p>Use certificate authentication (not client secrets) for production:</p>
<ul>
<li><strong>Certificates expire</strong> - Implement rotation strategy</li>
<li><strong>Store securely</strong> - Azure Key Vault or encrypted file system</li>
<li><strong>Monitor expiration</strong> - Alert 30 days before expiry</li>
</ul>
<p><strong>2. Least-Privilege Permissions</strong></p>
<p>Grant only necessary permissions:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Required Application Permissions (not Delegated)</span>
<span class="n">REQUIRED_PERMISSIONS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Files.ReadWrite.All&quot;</span><span class="p">,</span>  <span class="c1"># Read/write files</span>
    <span class="s2">&quot;Sites.ReadWrite.All&quot;</span>   <span class="c1"># Access SharePoint sites</span>
<span class="p">]</span>

<span class="c1"># DO NOT grant broader permissions like:</span>
<span class="c1"># - Files.ReadWrite.All with Delegated (allows user impersonation)</span>
<span class="c1"># - Sites.FullControl.All (excessive)</span>
</code></pre></div>
<p><strong>3. Input Validation</strong></p>
<p>Always validate user input before injecting into Excel:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_pump_selection</span><span class="p">(</span><span class="n">pump_name</span><span class="p">,</span> <span class="n">diameter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate user input to prevent injection attacks.&quot;&quot;&quot;</span>

    <span class="c1"># Whitelist approach</span>
    <span class="n">ALLOWED_PUMPS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Model-5000 HF&quot;</span><span class="p">,</span> <span class="s2">&quot;Kerr EF5&quot;</span><span class="p">,</span> <span class="s2">&quot;SPM WS335&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">ALLOWED_DIAMETERS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pump_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_PUMPS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid pump name: </span><span class="si">{</span><span class="n">pump_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">diameter</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_DIAMETERS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid diameter: </span><span class="si">{</span><span class="n">diameter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Prevent formula injection</span>
    <span class="n">dangerous_chars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">pump_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">dangerous_chars</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input contains forbidden characters&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>
<p><strong>4. Audit Logging</strong></p>
<p>Log all operations for compliance and debugging:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">audit_log</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log security-relevant actions.&quot;&quot;&quot;</span>
    <span class="n">log_entry</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>  <span class="c1"># e.g., &quot;EXCEL_UPDATE&quot;, &quot;PDF_GENERATE&quot;</span>
        <span class="s2">&quot;resource&quot;</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>  <span class="c1"># e.g., &quot;PumpComparison.xlsx&quot;</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>  <span class="c1"># &quot;SUCCESS&quot; or &quot;FAILURE&quot;</span>
        <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
        <span class="s2">&quot;ip_address&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span> <span class="k">if</span> <span class="n">request</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AUDIT: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">log_entry</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="error-handling-and-resilience">Error Handling and Resilience</h3>
<p><strong>1. Retry Logic for Transient Failures</strong></p>
<p>Graph API calls can fail due to network issues or throttling:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestException</span>

<span class="k">def</span><span class="w"> </span><span class="nf">call_with_retry</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">backoff_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute function with exponential backoff retry.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span>  <span class="c1"># Last attempt failed</span>

            <span class="n">wait_time</span> <span class="o">=</span> <span class="n">backoff_factor</span> <span class="o">**</span> <span class="n">attempt</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Retrying in </span><span class="si">{</span><span class="n">wait_time</span><span class="si">}</span><span class="s2">s...&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_time</span><span class="p">)</span>

<span class="c1"># Usage</span>
<span class="k">def</span><span class="w"> </span><span class="nf">safe_update_cell</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_op</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">update_cell</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">call_with_retry</span><span class="p">(</span><span class="n">update_op</span><span class="p">)</span>
</code></pre></div>
<p><strong>2. Graceful Degradation</strong></p>
<p>Handle missing charts or worksheets without crashing:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_charts_safe</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">workbook_base</span><span class="p">,</span> <span class="n">worksheet_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract charts with graceful failure handling.&quot;&quot;&quot;</span>
    <span class="n">chart_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">charts</span> <span class="o">=</span> <span class="n">list_charts</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">workbook_base</span><span class="p">,</span> <span class="n">worksheet_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">charts</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No charts found on &#39;</span><span class="si">{</span><span class="n">worksheet_name</span><span class="si">}</span><span class="s2">&#39; - continuing&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">chart_files</span>

        <span class="k">for</span> <span class="n">chart</span> <span class="ow">in</span> <span class="n">charts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">get_chart_image</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">workbook_base</span><span class="p">,</span> <span class="n">worksheet_name</span><span class="p">,</span> <span class="n">chart</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="c1"># Save chart...</span>
                <span class="n">chart_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract chart &#39;</span><span class="si">{</span><span class="n">chart</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Continue processing other charts</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to list charts on &#39;</span><span class="si">{</span><span class="n">worksheet_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">chart_files</span>
</code></pre></div>
<p><strong>3. Global Exception Handler</strong></p>
<p>Centralized exception handling for Flask:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="ne">Exception</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Global exception handler for all routes.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unhandled exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Don&#39;t expose internal errors to users</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
        <span class="n">get_error_template</span><span class="p">(),</span>
        <span class="n">error_message</span><span class="o">=</span><span class="s2">&quot;An unexpected error occurred. Please try again later.&quot;</span>
    <span class="p">),</span> <span class="mi">500</span>
</code></pre></div>
<p><strong>4. Session Timeout Handling</strong></p>
<p>Detect and recover from expired sessions:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_session_expired_error</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if error indicates session expiration.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;session&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;not found&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">update_cell_with_session_recovery</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">worksheet</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update cell with automatic session recovery.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">WORKBOOK_BASE</span><span class="si">}</span><span class="s2">/worksheets(&#39;</span><span class="si">{</span><span class="n">worksheet</span><span class="si">}</span><span class="s2">&#39;)/range(address=&#39;</span><span class="si">{</span><span class="n">cell</span><span class="si">}</span><span class="s2">&#39;)&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="n">value</span><span class="p">]]}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">workbook_headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">session_id</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_session_expired_error</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Session expired, creating new session...&quot;</span><span class="p">)</span>
        <span class="n">new_session_id</span> <span class="o">=</span> <span class="n">create_workbook_session</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">WORKBOOK_BASE</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">workbook_headers</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">new_session_id</span><span class="p">),</span> <span class="n">json</span><span class="o">=</span><span class="n">body</span><span class="p">)</span>

    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">r</span>
</code></pre></div>
<hr />
<h2 id="limitations-and-considerations">Limitations and Considerations</h2>
<ul>
<li><strong>Macro-Enabled Files:</strong> The Graph API cannot edit <code>.xlsm</code> files. Macros are not executed or updated.</li>
<li><strong>Security:</strong> All operations require Azure AD authentication and appropriate permissions.</li>
<li><strong>Concurrency:</strong> Use workbook sessions to avoid conflicts and ensure changes are saved.</li>
</ul>
<blockquote>
<p><strong>Reference:</strong> <a href="https://learn.microsoft.com/en-us/graph/api/resources/excel?view=graph-rest-1.0#limitations">Why can't macro-enabled Excel files be edited via Graph API?</a></p>
</blockquote>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>This article demonstrated a <strong>simple solution to a complex problem</strong>: automating Excel-based business workflows without duplicating logic in code.</p>
<h3 id="the-power-of-separation-of-concerns">The Power of Separation of Concerns</h3>
<p>By leveraging the Microsoft Graph API, you achieve a clean separation:</p>
<ul>
<li><strong>Subject Matter Experts</strong> (engineers, finance teams, clinicians) maintain business logic in Exceltheir domain of expertise</li>
<li><strong>Developers</strong> build intuitive web interfaces and robust infrastructure</li>
<li><strong>End Users</strong> get simple, accessible tools without needing Excel skills</li>
</ul>
<h3 id="what-weve-built">What We've Built</h3>
<p>This production-ready solution includes:</p>
<ol>
<li><strong>Azure AD Authentication</strong> - Certificate-based, secure access</li>
<li><strong>Excel Data Injection</strong> - REST API calls to update cells programmatically</li>
<li><strong>Automatic Formula Recalculation</strong> - Excel's native engine handles all calculations</li>
<li><strong>Chart Extraction</strong> - Export refreshed charts as PNG images</li>
<li><strong>PDF Report Generation</strong> - Professional reports with ReportLab</li>
<li><strong>Email Automation</strong> - Distribute reports to stakeholders</li>
<li><strong>Flask Web Application</strong> - Responsive UI for desktop, tablet, and mobile</li>
<li><strong>Production Features</strong> - Error handling, retry logic, audit logging, file cleanup</li>
</ol>
<h3 id="why-this-approach-wins">Why This Approach Wins</h3>
<table>
<thead>
<tr>
<th>Traditional Approach</th>
<th>Graph API Approach</th>
</tr>
</thead>
<tbody>
<tr>
<td>Weeks of development to duplicate Excel formulas</td>
<td>Reuse existing Excel, zero formula duplication</td>
</tr>
<tr>
<td>Code changes every time formulas change</td>
<td>Business users update Excel, no deployments</td>
</tr>
<tr>
<td>Requires Excel installation on servers</td>
<td>Cloud-native, works on any OS</td>
</tr>
<tr>
<td>COM automation, Windows-only</td>
<td>REST API, platform-independent</td>
</tr>
<tr>
<td>High infrastructure and licensing costs</td>
<td>Free with O365 subscription</td>
</tr>
</tbody>
</table>
<h3 id="real-world-applicability">Real-World Applicability</h3>
<p>This architecture applies to any scenario where:</p>
<p> Complex Excel workbooks contain valuable business logic
 Subject matter experts (not developers) maintain formulas
 Users need web/mobile access instead of native Excel
 Formulas change frequently due to business rules or regulations
 Reporting and visualization are critical</p>
<h3 id="key-technical-takeaways">Key Technical Takeaways</h3>
<ol>
<li><strong>No Excel Installation Required</strong> - Pure cloud-native solution using Microsoft Graph API</li>
<li><strong>Formula Execution Without Code</strong> - Excel's calculation engine handles VLOOKUPs, nested formulas, charts</li>
<li><strong>Only <code>.xlsx</code> Supported</strong> - Macro-enabled files (<code>.xlsm</code>) are not editable via Graph API</li>
<li><strong>Session Management Critical</strong> - Always close sessions to free server resources</li>
<li><strong>Input Validation Essential</strong> - Prevent formula injection attacks with whitelist validation</li>
<li><strong>Production-Ready Patterns</strong> - Token caching, retry logic, error handling, audit logging</li>
</ol>
<h3 id="the-bottom-line">The Bottom Line</h3>
<p>You don't need to choose between <strong>Excel's flexibility</strong> and <strong>web application accessibility</strong>.
You don't need to duplicate complex business logic in code.
You don't need expensive COM automation or Windows servers.</p>
<p><strong>The Microsoft Graph API gives you the best of both worlds</strong>: Excel's proven calculation engine + modern web architecture.</p>
<p>The result? <strong>A simple, elegant solution that saves weeks of development time and eliminates ongoing maintenance of duplicated logic.</strong></p>
<hr />
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/graph/api/resources/excel?view=graph-rest-1.0">Microsoft Graph Excel API Overview</a></li>
<li><a href="https://docs.python-requests.org/en/latest/">Python Requests Library</a></li>
<li><a href="https://www.reportlab.com/dev/docs/">ReportLab PDF Toolkit</a></li>
</ul>
<hr />







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="October 13, 2025 23:37:18 UTC">October 13, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.sections", "content.code.annotate", "content.code.copy"], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../assets/custom.js"></script>
      
    
  </body>
</html>