
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A professional blog showcasing business problem solutions.">
      
      
      
        <link rel="canonical" href="https://munishsethi.com/ai-claude-mcp-analytic-server-part3/">
      
      
        <link rel="prev" href="../ai-claude-mcp-analytic-server-part2/">
      
      
        <link rel="next" href="../azure-ad-certificate/">
      
      
      <link rel="icon" href="../None">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Data Analysis with LLM via MCP Server (files/database) https- Part 3 - Munish(s) Blog</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#secure-on-premises-data-analysis-with-llm-and-a-custom-mcp-server" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Munish(s) Blog" class="md-header__button md-logo" aria-label="Munish(s) Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Munish(s) Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Data Analysis with LLM via MCP Server (files/database) https- Part 3
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Munish(s) Blog" class="md-nav__button md-logo" aria-label="Munish(s) Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Munish(s) Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    AI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            AI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai-claude-mcp-analytic-server-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Analysis with LLM via MCP Server (csv/Parquet) stdio- Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ai-claude-mcp-analytic-server-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Analysis with LLM via MCP Server (database) stdio- Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Data Analysis with LLM via MCP Server (files/database) https- Part 3
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Data Analysis with LLM via MCP Server (files/database) https- Part 3
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#part-3-https-based-mcp-server-with-oauth-20-azure-entra-id-and-multi-tenant-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Part 3: HTTPS-Based MCP Server with OAuth 2.0 (Azure Entra ID) and Multi-Tenant Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 3: HTTPS-Based MCP Server with OAuth 2.0 (Azure Entra ID) and Multi-Tenant Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#series-navigation" class="md-nav__link">
    <span class="md-ellipsis">
      ðŸ“š Series Navigation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-from-stdio-to-https" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture: From Stdio to HTTPS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture: From Stdio to HTTPS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#previous-architecture-parts-1-2" class="md-nav__link">
    <span class="md-ellipsis">
      Previous Architecture (Parts 1 &amp; 2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#new-architecture-part-3" class="md-nav__link">
    <span class="md-ellipsis">
      New Architecture (Part 3)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-https-over-stdio" class="md-nav__link">
    <span class="md-ellipsis">
      Why HTTPS over Stdio?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-entra-app-registration-setup-and-gotchas" class="md-nav__link">
    <span class="md-ellipsis">
      Azure Entra App Registration: Setup and Gotchas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Azure Entra App Registration: Setup and Gotchas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-app-registration" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Create App Registration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-configure-api-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Configure API Permissions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-create-client-secret" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Create Client Secret
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-configure-redirect-uris" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Configure Redirect URIs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-expose-api-and-define-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Expose API and Define Scopes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gotcha-1-oauth-version-must-be-20" class="md-nav__link">
    <span class="md-ellipsis">
      ðŸš¨ Gotcha #1: OAuth Version Must Be 2.0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gotcha-2-claude-desktop-callback-url" class="md-nav__link">
    <span class="md-ellipsis">
      ðŸš¨ Gotcha #2: Claude Desktop Callback URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-note-your-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6: Note Your Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-tenant-architecture-business-function-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Tenant Architecture: Business Function Routing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multi-Tenant Architecture: Business Function Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#business-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Business Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-url-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Connection URL Examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-isolation-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Data Isolation Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-code-walkthrough-analystpy-https-version" class="md-nav__link">
    <span class="md-ellipsis">
      Full Code Walkthrough: analyst.py (HTTPS Version)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Full Code Walkthrough: analyst.py (HTTPS Version)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-logging-and-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      1. Logging and Initialization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-azure-key-vault-integration" class="md-nav__link">
    <span class="md-ellipsis">
      2. Azure Key Vault Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-business-function-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      3. Business Function Middleware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-oauth-20-azure-entra-id-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      4. OAuth 2.0 (Azure Entra ID) Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-database-connection-management" class="md-nav__link">
    <span class="md-ellipsis">
      5. Database Connection Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-file-reading-with-sap-support" class="md-nav__link">
    <span class="md-ellipsis">
      6. File Reading with SAP Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-user-context-extraction" class="md-nav__link">
    <span class="md-ellipsis">
      7. User Context Extraction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-mcp-tool-connection-info" class="md-nav__link">
    <span class="md-ellipsis">
      8. MCP Tool: Connection Info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-mcp-tool-data-catalog-auto-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      9. MCP Tool: Data Catalog (Auto-Discovery)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-mcp-tool-get-schema-files" class="md-nav__link">
    <span class="md-ellipsis">
      10. MCP Tool: Get Schema (Files)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11-mcp-tool-get-schema-database" class="md-nav__link">
    <span class="md-ellipsis">
      11. MCP Tool: Get Schema (Database)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-mcp-tool-execute-polars-sql-files" class="md-nav__link">
    <span class="md-ellipsis">
      12. MCP Tool: Execute Polars SQL (Files)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-mcp-tool-execute-database-query-sql-server" class="md-nav__link">
    <span class="md-ellipsis">
      13. MCP Tool: Execute Database Query (SQL Server)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-main-entry-point-and-server-startup" class="md-nav__link">
    <span class="md-ellipsis">
      14. Main Entry Point and Server Startup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-azure-container-instance-with-tls-offloading" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment: Azure Container Instance with TLS Offloading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment: Azure Container Instance with TLS Offloading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#container-build-and-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Container Build and Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tls-offloading-with-fortigate" class="md-nav__link">
    <span class="md-ellipsis">
      TLS Offloading with FortiGate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#claude-desktop-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Claude Desktop Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Security Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-authentication-and-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      1. Authentication and Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-data-protection" class="md-nav__link">
    <span class="md-ellipsis">
      2. Data Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-secrets-management" class="md-nav__link">
    <span class="md-ellipsis">
      3. Secrets Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-network-security" class="md-nav__link">
    <span class="md-ellipsis">
      4. Network Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-and-scalability" class="md-nav__link">
    <span class="md-ellipsis">
      Performance and Scalability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance and Scalability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scaling-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling Strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-metrics-to-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Key Metrics to Monitor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-issues-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Common Issues and Solutions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lessons-learned" class="md-nav__link">
    <span class="md-ellipsis">
      Lessons Learned
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lessons Learned">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-worked-well" class="md-nav__link">
    <span class="md-ellipsis">
      What Worked Well
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenges-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Challenges and Solutions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-and-credits" class="md-nav__link">
    <span class="md-ellipsis">
      References and Credits
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Azure
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Azure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-ad-certificate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Based Authentication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-billing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Download Azure Bill
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Download Azure Resource
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-query-recovery-services-vault/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Query Recovery Services Vault
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-ad-user/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Entra Users, User Groups and Licence assignments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-ad-user-devices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Entra User Devices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-container-schedule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Orchestrating Scheduled Jobs (Container Instances)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops-build-container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DevOps Build Container
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops-deploy-container-iac/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DevOps Deploy Container IaC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devops-deploy-container-github-action/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DevOps Deploy Container Github Actions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../avd-custon-image-compute-gallery-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Building and Publishing an Custom Image
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../avd-publish-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploying Azure Virtual Desktop (AVD) Desktops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../avd-cleanup-obsolete-fsLogix-profiles/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cleanup Obsolete FXLogix Profiles(AVD)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-bcpdr-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Business Coninuity Program / Diasister Recovery - Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-bcpdr-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Business Continuity Program / Disaster Recovery - Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-bcpdr-github-action/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Business Continuity Program / Disaster Recovery - Git Hub Action
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-restore-from-backup-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Restore VM from RSV Backup - Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../azure-restore-from-backup-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Restore VM from RSV Backup - Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Fabric
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Fabric
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fabric-wharehouse-fact-import/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Warehouse data import
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Cisco Meraki, Nagios XI & Manage Engine
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Cisco Meraki, Nagios XI & Manage Engine
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meraki-unused-device-sync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cisco Meraki Unused Devices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meraki-nagios-device-sync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cisco Meraki Devices Discovery and Nagios Integration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../monitoring-itsm-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Integrating Monitoring System with ITSM System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meraki-vm-deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deploying Cisco Meraki vMX
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Active Directory Domain Services
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Active Directory Domain Services
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adds-user-creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create ADDS User
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adds-user-update/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Update ADDS User
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    SAP
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            SAP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-rfc-python-container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup PyRFC in your Container
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-rfc-python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Calling SAP RFC Function Modules from Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-system-start-stop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Automating SAP System Start/Stop Operations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    O365
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            O365
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adaptive-card-consultant-review-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Outlook Actionable Adaptive Card - Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../adaptive-card-consultant-review-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Outlook Actionable Adaptive Card - Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-sites-enumeration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sharepoint Sites Enumeration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-site-library-enumeration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sharepoint Document Library Enumeration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharepoint-site-library-to-azure-fileshare/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migrate Sharepoint Document Library to Azure File Share
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sap-concur-expense-reports-aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Concur Expense Report Aggregation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../teams-user-number-assignment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Get all Teams Phone Assignment(s)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deprovision-user/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deprovison User
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tenantallowblocklist/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tenant Allow Block List - False Positive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    O365 and Proof Point Essentials - Part 1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    O365 and Proof Point Essentials - Part 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    O365 and Proof Point Essentials - Part 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    O365 and Proof Point Essentials - Part 4
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-o365-proofpoint-part5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    O365 and Proof Point Essentials - Part 5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spo-o365_excel_automation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    O365/Excel Automation via SPO
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    UKG
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            UKG
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-sftp-file-transfer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Secure File Transfer with UKG Dimensions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-api-employee-verification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Employee Verification via API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ukg-api-integration-and-dataview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Automating Integration Execution and Dataview extract
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Misc
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proofpoint-user-management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proof Point User Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../github-clean-deployments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Clean GitHub Deployments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../proofpointo365connector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Understanding DMARC/Spoofing, O365 with ProofPoint
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#part-3-https-based-mcp-server-with-oauth-20-azure-entra-id-and-multi-tenant-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Part 3: HTTPS-Based MCP Server with OAuth 2.0 (Azure Entra ID) and Multi-Tenant Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Part 3: HTTPS-Based MCP Server with OAuth 2.0 (Azure Entra ID) and Multi-Tenant Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#series-navigation" class="md-nav__link">
    <span class="md-ellipsis">
      ðŸ“š Series Navigation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture-from-stdio-to-https" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture: From Stdio to HTTPS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture: From Stdio to HTTPS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#previous-architecture-parts-1-2" class="md-nav__link">
    <span class="md-ellipsis">
      Previous Architecture (Parts 1 &amp; 2)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#new-architecture-part-3" class="md-nav__link">
    <span class="md-ellipsis">
      New Architecture (Part 3)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-https-over-stdio" class="md-nav__link">
    <span class="md-ellipsis">
      Why HTTPS over Stdio?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#azure-entra-app-registration-setup-and-gotchas" class="md-nav__link">
    <span class="md-ellipsis">
      Azure Entra App Registration: Setup and Gotchas
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Azure Entra App Registration: Setup and Gotchas">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-create-app-registration" class="md-nav__link">
    <span class="md-ellipsis">
      Step 1: Create App Registration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-configure-api-permissions" class="md-nav__link">
    <span class="md-ellipsis">
      Step 2: Configure API Permissions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-3-create-client-secret" class="md-nav__link">
    <span class="md-ellipsis">
      Step 3: Create Client Secret
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-4-configure-redirect-uris" class="md-nav__link">
    <span class="md-ellipsis">
      Step 4: Configure Redirect URIs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-5-expose-api-and-define-scopes" class="md-nav__link">
    <span class="md-ellipsis">
      Step 5: Expose API and Define Scopes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gotcha-1-oauth-version-must-be-20" class="md-nav__link">
    <span class="md-ellipsis">
      ðŸš¨ Gotcha #1: OAuth Version Must Be 2.0
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gotcha-2-claude-desktop-callback-url" class="md-nav__link">
    <span class="md-ellipsis">
      ðŸš¨ Gotcha #2: Claude Desktop Callback URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-6-note-your-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Step 6: Note Your Configuration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-tenant-architecture-business-function-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Tenant Architecture: Business Function Routing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Multi-Tenant Architecture: Business Function Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#business-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Business Functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#connection-url-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Connection URL Examples
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-isolation-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Data Isolation Structure
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-code-walkthrough-analystpy-https-version" class="md-nav__link">
    <span class="md-ellipsis">
      Full Code Walkthrough: analyst.py (HTTPS Version)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Full Code Walkthrough: analyst.py (HTTPS Version)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-logging-and-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      1. Logging and Initialization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-azure-key-vault-integration" class="md-nav__link">
    <span class="md-ellipsis">
      2. Azure Key Vault Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-business-function-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      3. Business Function Middleware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-oauth-20-azure-entra-id-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      4. OAuth 2.0 (Azure Entra ID) Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-database-connection-management" class="md-nav__link">
    <span class="md-ellipsis">
      5. Database Connection Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-file-reading-with-sap-support" class="md-nav__link">
    <span class="md-ellipsis">
      6. File Reading with SAP Support
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-user-context-extraction" class="md-nav__link">
    <span class="md-ellipsis">
      7. User Context Extraction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-mcp-tool-connection-info" class="md-nav__link">
    <span class="md-ellipsis">
      8. MCP Tool: Connection Info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-mcp-tool-data-catalog-auto-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      9. MCP Tool: Data Catalog (Auto-Discovery)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-mcp-tool-get-schema-files" class="md-nav__link">
    <span class="md-ellipsis">
      10. MCP Tool: Get Schema (Files)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11-mcp-tool-get-schema-database" class="md-nav__link">
    <span class="md-ellipsis">
      11. MCP Tool: Get Schema (Database)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-mcp-tool-execute-polars-sql-files" class="md-nav__link">
    <span class="md-ellipsis">
      12. MCP Tool: Execute Polars SQL (Files)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-mcp-tool-execute-database-query-sql-server" class="md-nav__link">
    <span class="md-ellipsis">
      13. MCP Tool: Execute Database Query (SQL Server)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-main-entry-point-and-server-startup" class="md-nav__link">
    <span class="md-ellipsis">
      14. Main Entry Point and Server Startup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-azure-container-instance-with-tls-offloading" class="md-nav__link">
    <span class="md-ellipsis">
      Deployment: Azure Container Instance with TLS Offloading
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deployment: Azure Container Instance with TLS Offloading">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#container-build-and-deployment" class="md-nav__link">
    <span class="md-ellipsis">
      Container Build and Deployment
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tls-offloading-with-fortigate" class="md-nav__link">
    <span class="md-ellipsis">
      TLS Offloading with FortiGate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#claude-desktop-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Claude Desktop Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Security Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Security Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-authentication-and-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      1. Authentication and Authorization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-data-protection" class="md-nav__link">
    <span class="md-ellipsis">
      2. Data Protection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-secrets-management" class="md-nav__link">
    <span class="md-ellipsis">
      3. Secrets Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-network-security" class="md-nav__link">
    <span class="md-ellipsis">
      4. Network Security
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-and-scalability" class="md-nav__link">
    <span class="md-ellipsis">
      Performance and Scalability
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance and Scalability">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#performance-characteristics" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Characteristics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scaling-strategies" class="md-nav__link">
    <span class="md-ellipsis">
      Scaling Strategies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#monitoring-and-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Monitoring and Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Monitoring and Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-metrics-to-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Key Metrics to Monitor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#common-issues-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Common Issues and Solutions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lessons-learned" class="md-nav__link">
    <span class="md-ellipsis">
      Lessons Learned
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lessons Learned">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-worked-well" class="md-nav__link">
    <span class="md-ellipsis">
      What Worked Well
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#challenges-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Challenges and Solutions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#future-enhancements" class="md-nav__link">
    <span class="md-ellipsis">
      Future Enhancements
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-and-credits" class="md-nav__link">
    <span class="md-ellipsis">
      References and Credits
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="secure-on-premises-data-analysis-with-llm-and-a-custom-mcp-server">Secure, On-Premises Data Analysis with LLM and a Custom MCP Server</h1>
<h2 id="part-3-https-based-mcp-server-with-oauth-20-azure-entra-id-and-multi-tenant-architecture">Part 3: HTTPS-Based MCP Server with OAuth 2.0 (Azure Entra ID) and Multi-Tenant Architecture</h2>
<h3 id="series-navigation">ðŸ“š <strong>Series Navigation</strong></h3>
<ul>
<li><a href="../ai-claude-mcp-analytic-server-part1/">Part 1: CSV/Parquet files</a></li>
<li><a href="../ai-claude-mcp-analytic-server-part2/">Part 2: CSV/Parquet &amp; Database</a></li>
<li><strong>Part 3: HTTPS-Based MCP Server with OAuth 2.0 (Azure Entra ID)</strong> <em>(Current)</em></li>
</ul>
<hr />
<p><em>This is Part 3 of the series. Here, we extend the solution to use MCP Server over HTTPS</em></p>
<h2 id="introduction">Introduction</h2>
<p>From a business end-user perspective, the core problem this solution addresses is enabling anyone in the organization to ask questions of our internal dataâ€”whether in files or databasesâ€”using natural language, without needing to know SQL or technical query languages. By leveraging a large language model (LLM), users can simply describe what they want to know, and the LLM translates those requests into the correct queries, helping us analyze our data more efficiently and intuitively. This democratizes access to analytics, reduces dependency on technical staff, and accelerates business insights.</p>
<p>The technical solution ensures this is done securely and at scale: deploying an MCP server over HTTP(S) with enterprise authentication, so all data remains protected and accessible only to authorized users.</p>
<p>While the stdio-based MCP server from Parts 1 and 2 works well for individual users on Windows desktops, enterprise environments demand more:</p>
<ul>
<li><strong>Centralized deployment:</strong> One server for all users, not executables on every PC</li>
<li><strong>Secure authentication:</strong> Enterprise SSO via Azure Entra ID (formerly Azure AD)</li>
<li><strong>Multi-tenant architecture:</strong> Support for multiple business functions (IT, HR, Finance) with isolated data access</li>
<li><strong>Cloud-native deployment:</strong> Containerized for Azure Container Instances or Kubernetes</li>
<li><strong>HTTPS connectivity:</strong> Compatible with Claude Desktop (paid tier), web clients, and API integrations</li>
</ul>
<p>This article shows how to transform the local MCP server into a production-ready, enterprise service that:
- Authenticates users via OAuth 2.0 (Azure Entra ID)
- Routes requests to function-specific data catalogs (IT, HR, FIN)
- Runs as a containerized service with TLS offloading
- Integrates with Claude Desktop's custom HTTPS connector</p>
<p><strong>All data and computation remain on-premises or in your Azure tenantâ€”no third-party cloud services involved.</strong></p>
<hr />
<h2 id="architecture-from-stdio-to-https">Architecture: From Stdio to HTTPS</h2>
<h3 id="previous-architecture-parts-1-2">Previous Architecture (Parts 1 &amp; 2)</h3>
<p><div class="highlight"><pre><span></span><code>[Claude Desktop] â†â†’ [stdio] â†â†’ [analyst.exe] â†â†’ [Local Files/Database]
</code></pre></div>
- Simple, single-user, Windows-only
- No authentication
- Manual executable deployment per user</p>
<h3 id="new-architecture-part-3">New Architecture (Part 3)</h3>
<div class="highlight"><pre><span></span><code>[Claude Desktop (Paid)] â†â†’ [HTTPS/OAuth] â†â†’ [Azure Container Instance]
                                                    â†“
                                              [FortiGate TLS]
                                                    â†“
                                            [MCP Server + Auth]
                                                    â†“
                               [Business Function Router (IT/HR/FIN)]
                                    â†“              â†“            â†“
                          [IT Data Catalog] [HR Catalog] [FIN Catalog]
                                    â†“              â†“            â†“
                            [Files + Database per Function]
</code></pre></div>
<p><strong>Key improvements:</strong>
- <strong>OAuth 2.0 (Azure Entra ID):</strong> Handles authentication and authorization
- <strong>Multi-tenancy:</strong> Single server supports multiple business functions with isolated data
- <strong>Cloud deployment:</strong> Runs as a container in Azure Container Instances
- <strong>TLS offloading:</strong> FortiGate/FortiWeb handles SSL/TLS termination
- <strong>HTTPS connectivity:</strong> Any HTTP client can connect (Claude Desktop, web apps, APIs)</p>
<hr />
<h2 id="why-https-over-stdio">Why HTTPS over Stdio?</h2>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Stdio (Parts 1 &amp; 2)</th>
<th>HTTPS (Part 3)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deployment</td>
<td>Executable per user</td>
<td>Single centralized service</td>
</tr>
<tr>
<td>Authentication</td>
<td>None</td>
<td>OAuth 2.0 (Azure Entra ID)</td>
</tr>
<tr>
<td>Client support</td>
<td>Claude Desktop (local)</td>
<td>Claude Desktop (paid), web, mobile, APIs</td>
</tr>
<tr>
<td>Multi-user</td>
<td>No</td>
<td>Yes, with per-user context</td>
</tr>
<tr>
<td>Scalability</td>
<td>One user per process</td>
<td>Hundreds of concurrent users</td>
</tr>
<tr>
<td>Security</td>
<td>Local file access</td>
<td>Enterprise SSO + role-based access</td>
</tr>
<tr>
<td>Updates</td>
<td>Redeploy to every PC</td>
<td>Deploy once, all users benefit</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="azure-entra-app-registration-setup-and-gotchas">Azure Entra App Registration: Setup and Gotchas</h2>
<p>Before deploying the MCP server, you must configure Azure Entra ID (formerly Azure AD) for OAuth 2.0 authentication.</p>
<h3 id="step-1-create-app-registration">Step 1: Create App Registration</h3>
<ol>
<li>Navigate to <strong>Azure Portal â†’ Entra ID â†’ App Registrations â†’ New Registration</strong></li>
<li>Configure basic settings:</li>
<li><strong>Name:</strong> <code>MCP-Analyst-Server</code></li>
<li><strong>Supported account types:</strong> Accounts in this organizational directory only (single tenant)</li>
<li><strong>Redirect URI:</strong> Leave blank for now (we'll add it next)</li>
</ol>
<h3 id="step-2-configure-api-permissions">Step 2: Configure API Permissions</h3>
<ol>
<li>Go to <strong>API Permissions â†’ Add a permission â†’ Microsoft Graph</strong></li>
<li>Add <strong>Delegated permissions:</strong></li>
<li><code>User.Read</code> (to read user profile)</li>
<li><code>email</code>, <code>profile</code>, <code>openid</code> (standard OAuth scopes)</li>
<li><strong>Grant admin consent</strong> for your organization</li>
</ol>
<h3 id="step-3-create-client-secret">Step 3: Create Client Secret</h3>
<ol>
<li>Go to <strong>Certificates &amp; secrets â†’ New client secret</strong></li>
<li><strong>Description:</strong> <code>MCP Server Secret</code></li>
<li><strong>Expires:</strong> 24 months (or per your security policy)</li>
<li><strong>Copy the secret value immediately</strong> (it won't be shown again)</li>
</ol>
<h3 id="step-4-configure-redirect-uris">Step 4: Configure Redirect URIs</h3>
<p>This is <strong>critical for Claude Desktop integration:</strong></p>
<ol>
<li>Go to <strong>Authentication â†’ Add a platform â†’ Web</strong></li>
<li>Add the following <strong>Redirect URIs:</strong>
   <div class="highlight"><pre><span></span><code>https://mcp.gdenergyproducts.com/oauth/callback
https://claude.ai/api/mcp/auth_callback
</code></pre></div></li>
<li><strong>First URI:</strong> Your MCP server's OAuth callback endpoint</li>
<li>
<p><strong>Second URI:</strong> <strong>Required for Claude Desktop</strong> (paid tier) to act as OAuth proxy</p>
<ul>
<li>Claude Desktop intercepts the OAuth flow and forwards tokens to your MCP server</li>
<li>Without this, Claude Desktop cannot complete authentication</li>
</ul>
</li>
<li>
<p>Enable <strong>ID tokens</strong> and <strong>Access tokens</strong> checkboxes</p>
</li>
</ol>
<h3 id="step-5-expose-api-and-define-scopes">Step 5: Expose API and Define Scopes</h3>
<ol>
<li>Go to <strong>Expose an API â†’ Add a scope</strong></li>
<li><strong>Scope name:</strong> <code>access_as_user</code></li>
<li><strong>Who can consent:</strong> Admins and users</li>
<li><strong>Admin consent display name:</strong> Access MCP Analyst as user</li>
<li><strong>Description:</strong> Allows the application to access MCP Analyst on behalf of the signed-in user</li>
</ol>
<h3 id="gotcha-1-oauth-version-must-be-20">ðŸš¨ Gotcha #1: OAuth Version Must Be 2.0</h3>
<p>By default, Azure Entra creates apps with OAuth version <strong>1.0</strong>, but MCP servers <strong>require version 2.0</strong> for proper token handling.</p>
<p><strong>Manual fix required:</strong></p>
<ol>
<li>Go to <strong>App Registration â†’ Manifest</strong></li>
<li>Find the line: <code>"accessTokenAcceptedVersion": null</code> or <code>"accessTokenAcceptedVersion": 1</code></li>
<li>Change it to: <code>"accessTokenAcceptedVersion": 2</code></li>
<li><strong>Save the manifest</strong></li>
</ol>
<p><strong>Why this matters:</strong>
- OAuth 1.0 tokens use different claims and formats
- MCP's <code>AzureProvider</code> expects v2 tokens with <code>preferred_username</code>, <code>oid</code>, and <code>name</code> claims
- Without this change, authentication will fail with cryptic token validation errors</p>
<h3 id="gotcha-2-claude-desktop-callback-url">ðŸš¨ Gotcha #2: Claude Desktop Callback URL</h3>
<p>When testing with <strong>Claude Desktop (paid tier)</strong>, you <strong>must add</strong> this specific callback URL:</p>
<div class="highlight"><pre><span></span><code>https://claude.ai/api/mcp/auth_callback
</code></pre></div>
<p><strong>Why this is needed:</strong>
- Claude Desktop acts as an <strong>OAuth proxy</strong> for custom MCP servers
- When a user clicks "Connect" in Claude Desktop, it:
  1. Opens the Azure Entra login page in the browser
  2. User authenticates
  3. Azure redirects to <code>https://claude.ai/api/mcp/auth_callback</code> with auth code
  4. Claude Desktop exchanges the code for tokens
  5. Claude Desktop forwards tokens to your MCP server
- Without this callback URL, the OAuth flow breaks at step 3</p>
<p><strong>Security note:</strong>
- Claude Desktop only proxies the OAuth flow; it does <strong>not</strong> store or access your data
- All MCP queries and data remain between Claude Desktop â†’ Your MCP Server â†’ Your Data</p>
<h3 id="step-6-note-your-configuration">Step 6: Note Your Configuration</h3>
<p>Save these values for later use (will be stored in Azure Key Vault):</p>
<div class="highlight"><pre><span></span><code>Application (client) ID: &lt;your-client-id&gt;
Client Secret: &lt;your-secret-value&gt;
Directory (tenant) ID: &lt;your-tenant-id&gt;
</code></pre></div>
<hr />
<h2 id="multi-tenant-architecture-business-function-routing">Multi-Tenant Architecture: Business Function Routing</h2>
<p>One of the key innovations in this implementation is <strong>business function isolation</strong>. Instead of one data catalog for everyone, the server dynamically routes users to function-specific catalogs based on URL parameters.</p>
<h3 id="business-functions">Business Functions</h3>
<p>This implementation supports three business functions:</p>
<ol>
<li><strong>IT (<code>it</code>)</strong>: Infrastructure, device inventory, license management, Active Directory</li>
<li><strong>HR (<code>hr</code>)</strong>: Employee data, terminations, organizational charts, ADP snapshots</li>
<li><strong>Finance (<code>fin</code>)</strong>: Budget, expenses, procurement, SAP exports</li>
</ol>
<h3 id="connection-url-examples">Connection URL Examples</h3>
<ul>
<li>IT users: <code>https://mcp.gdenergyproducts.com/mcp?function=it</code></li>
<li>HR users: <code>https://mcp.gdenergyproducts.com/mcp?function=hr</code></li>
<li>Finance users: <code>https://mcp.gdenergyproducts.com/mcp?function=fin</code></li>
</ul>
<h3 id="data-isolation-structure">Data Isolation Structure</h3>
<div class="highlight"><pre><span></span><code>/mnt/azure/mcp/
â”œâ”€â”€ it/
â”‚   â”œâ”€â”€ data_catalog.json
â”‚   â”œâ”€â”€ device_inventory.csv
â”‚   â”œâ”€â”€ licenses.csv
â”‚   â””â”€â”€ accounts_to_be_deleted.csv
â”œâ”€â”€ hr/
â”‚   â”œâ”€â”€ data_catalog.json
â”‚   â”œâ”€â”€ idp_hr.csv
â”‚   â””â”€â”€ terminations.csv
â””â”€â”€ fin/
    â”œâ”€â”€ data_catalog.json
    â”œâ”€â”€ budget.csv
    â””â”€â”€ sap_expenses.csv
</code></pre></div>
<p><strong>Each function has:</strong>
- Its own <code>data_catalog.json</code> with function-specific datasets
- Isolated file storage (IT users can't access HR files)
- Separate database views (e.g., <code>mcp.it_employees</code>, <code>mcp.hr_employees</code>)</p>
<hr />
<h2 id="full-code-walkthrough-analystpy-https-version">Full Code Walkthrough: <code>analyst.py</code> (HTTPS Version)</h2>
<p>Below is a comprehensive walkthrough of the production code, covering <strong>85%+ of the implementation</strong>.</p>
<h3 id="1-logging-and-initialization">1. Logging and Initialization</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logging.handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">RotatingFileHandler</span>

<span class="n">LOG_SEPARATOR</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span>

<span class="k">def</span><span class="w"> </span><span class="nf">setup_logger</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">log_file</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure structured logging with rotation&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(name)s</span><span class="s2"> - &quot;</span>
        <span class="s2">&quot;</span><span class="si">%(funcName)s</span><span class="s2">:</span><span class="si">%(lineno)d</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
        <span class="c1"># File handler with 10MB rotation, keep 5 backups</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">RotatingFileHandler</span><span class="p">(</span>
            <span class="n">log_file</span><span class="p">,</span> 
            <span class="n">maxBytes</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> 
            <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="c1"># Console handler for development</span>
        <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">setup_logger</span><span class="p">(</span><span class="s2">&quot;gdepmcp&quot;</span><span class="p">,</span> <span class="s2">&quot;/mnt/azure/logs/gdepmcp.log&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">LOG_SEPARATOR</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GDEP MCP Server Starting&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">LOG_SEPARATOR</span><span class="p">)</span>

<span class="c1"># Suppress deprecation warnings in production</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
</code></pre></div>
<p><strong>Key points:</strong>
- <strong>Structured logging:</strong> Every request, tool call, and error is logged with context
- <strong>Log rotation:</strong> Prevents disk fill-up in production (10MB per file, 5 backups)
- <strong>Dual output:</strong> File for auditing, console for development/debugging
- <strong>Function/line tracking:</strong> Easy debugging with function name and line number in logs</p>
<hr />
<h3 id="2-azure-key-vault-integration">2. Azure Key Vault Integration</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">azure.identity</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientSecretCredential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">azure.keyvault.secrets</span><span class="w"> </span><span class="kn">import</span> <span class="n">SecretClient</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_azure_kv_secret</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve secrets from Azure Key Vault&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vault_url</span> <span class="o">=</span> <span class="s2">&quot;https://kv-gdep-peus-interfaces.vault.azure.net/&quot;</span>

        <span class="c1"># Service principal credentials from environment variables</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;application_interface_clientid&quot;</span><span class="p">)</span>
        <span class="n">client_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;application_interface_clientsecret&quot;</span><span class="p">)</span>
        <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;application_interface_tenantid&quot;</span><span class="p">)</span>

        <span class="n">credential</span> <span class="o">=</span> <span class="n">ClientSecretCredential</span><span class="p">(</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">client_id</span><span class="p">,</span>
            <span class="n">client_secret</span><span class="o">=</span><span class="n">client_secret</span><span class="p">,</span>
            <span class="n">tenant_id</span><span class="o">=</span><span class="n">tenant_id</span>
        <span class="p">)</span>

        <span class="n">secret_client</span> <span class="o">=</span> <span class="n">SecretClient</span><span class="p">(</span>
            <span class="n">vault_url</span><span class="o">=</span><span class="n">vault_url</span><span class="p">,</span> 
            <span class="n">credential</span><span class="o">=</span><span class="n">credential</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">secret_client</span><span class="o">.</span><span class="n">get_secret</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving Azure KV secret &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<span class="c1"># Load OAuth credentials from Key Vault</span>
<span class="n">AZURE_CONFIDENTIAL_APP_ID</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
    <span class="n">get_azure_kv_secret</span><span class="p">(</span><span class="s1">&#39;mcp-authentication-clientid&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">AZURE_CONFIDENTIAL_SECRET</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
    <span class="n">get_azure_kv_secret</span><span class="p">(</span><span class="s1">&#39;mcp-authentication-clientsecret&#39;</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Why Key Vault?</strong>
- <strong>Never hardcode secrets:</strong> Client IDs and secrets are injected at runtime
- <strong>Centralized management:</strong> Rotate secrets without redeploying code
- <strong>Audit trail:</strong> Key Vault logs all secret access
- <strong>Role-based access:</strong> Only authorized apps/users can read secrets</p>
<p><strong>Required environment variables (set in container):</strong>
<div class="highlight"><pre><span></span><code><span class="nv">application_interface_clientid</span><span class="o">=</span>&lt;service-principal-client-id&gt;
<span class="nv">application_interface_clientsecret</span><span class="o">=</span>&lt;service-principal-secret&gt;
<span class="nv">application_interface_tenantid</span><span class="o">=</span>&lt;azure-tenant-id&gt;
</code></pre></div></p>
<hr />
<h3 id="3-business-function-middleware">3. Business Function Middleware</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">starlette.requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">starlette.middleware.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseHTTPMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextvars</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextVar</span>

<span class="n">current_function</span> <span class="o">=</span> <span class="n">ContextVar</span><span class="p">(</span><span class="s1">&#39;current_function&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;it&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">BusinessFunctionExtractionMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract business function from query string and store in context&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">):</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">business_function</span> <span class="o">=</span> <span class="s2">&quot;na&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Incoming request - Host: </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Path: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">, Method: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Extract function from query string</span>
        <span class="n">function_via_query_string</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">function_via_query_string</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;it&quot;</span><span class="p">,</span> <span class="s2">&quot;hr&quot;</span><span class="p">,</span> <span class="s2">&quot;fin&quot;</span><span class="p">}:</span>
            <span class="n">business_function</span> <span class="o">=</span> <span class="n">function_via_query_string</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;DEBUG MODE: Using business_function from query &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;parameter: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Store in request context (async-safe via ContextVar)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">business_function</span> <span class="o">=</span> <span class="n">business_function</span>
        <span class="n">current_function</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">business_function</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Set request.state.business_function = </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Response status: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;for business_function: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_current_business_function</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get business function from context variable (thread-safe)&quot;&quot;&quot;</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">current_function</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Retrieved current business function from context: </span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">function</span>
</code></pre></div>
<p><strong>How this works:</strong>
1. <strong>Request arrives</strong> at <code>/mcp?function=it</code>
2. <strong>Middleware intercepts</strong> before MCP tools execute
3. <strong>Extracts <code>function</code> parameter</strong> from query string
4. <strong>Validates</strong> against allowed functions (<code>it</code>, <code>hr</code>, <code>fin</code>)
5. <strong>Stores in context</strong> using Python's <code>ContextVar</code> (async-safe)
6. <strong>All subsequent tool calls</strong> read from context to route to correct data</p>
<p><strong>Security:</strong>
- Invalid functions (<code>na</code>) result in "no data found" responses
- No cross-contamination between business functions
- Each user's requests are isolated in async context
- Supports concurrent requests from multiple users</p>
<hr />
<h3 id="4-oauth-20-azure-entra-id-configuration">4. OAuth 2.0 (Azure Entra ID) Configuration</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp</span><span class="w"> </span><span class="kn">import</span> <span class="n">FastMCP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp.server.auth.providers.azure</span><span class="w"> </span><span class="kn">import</span> <span class="n">AzureProvider</span>

<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Configuring OAuth 2.0 (Azure Entra ID) Provider&quot;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">azure_auth</span> <span class="o">=</span> <span class="n">AzureProvider</span><span class="p">(</span>
        <span class="n">client_id</span><span class="o">=</span><span class="n">AZURE_CONFIDENTIAL_APP_ID</span><span class="p">,</span>
        <span class="n">client_secret</span><span class="o">=</span><span class="n">AZURE_CONFIDENTIAL_SECRET</span><span class="p">,</span>
        <span class="n">tenant_id</span><span class="o">=</span><span class="s2">&quot;00b1a755-0b06-4d05-9a59-259ebf7f9e00&quot;</span><span class="p">,</span>
        <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;https://mcp.gdenergyproducts.com&quot;</span><span class="p">,</span>
        <span class="n">required_scopes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;access_as_user&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;OAuth 2.0 (Azure Entra ID) Provider configured successfully&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Failed to configure OAuth 2.0 (Azure Entra ID) Provider: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
        <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">raise</span>

<span class="c1"># Initialize FastMCP with authentication</span>
<span class="n">mcp</span> <span class="o">=</span> <span class="n">FastMCP</span><span class="p">(</span><span class="s2">&quot;gdep-analyst&quot;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">azure_auth</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FastMCP instance initialized successfully&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Configuration breakdown:</strong>
- <strong><code>client_id</code></strong>: Your Azure App Registration's Application ID
- <strong><code>client_secret</code></strong>: Secret created in App Registration
- <strong><code>tenant_id</code></strong>: Your organization's Azure tenant ID
- <strong><code>base_url</code></strong>: Public URL of your MCP server (for OAuth callbacks)
- <strong><code>required_scopes</code></strong>: API scopes defined in "Expose an API" section</p>
<p><strong>What happens during OAuth:</strong>
1. User connects in Claude Desktop â†’ redirected to Azure login
2. User authenticates with corporate credentials
3. Azure validates and issues tokens with <code>access_as_user</code> scope
4. MCP server validates token signature and claims
5. Request proceeds with user context (email, name, object ID)</p>
<hr />
<h3 id="5-database-connection-management">5. Database Connection Management</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pyodbc</span>

<span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_connection_string</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_connection_string</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build SQL Server connection string from Key Vault&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building database connection string&quot;</span><span class="p">)</span>
    <span class="n">conn_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_azure_kv_secret</span><span class="p">(</span><span class="s1">&#39;mcp-sql-conn-string&#39;</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database connection string built successfully&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn_str</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_db_connection</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get or create database connection with connection pooling&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_connection</span><span class="p">,</span> <span class="n">_connection_string</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Getting database connection&quot;</span><span class="p">)</span>

    <span class="c1"># Lazy initialization</span>
    <span class="k">if</span> <span class="n">_connection_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connection string not initialized, building new one&quot;</span><span class="p">)</span>
        <span class="n">_connection_string</span> <span class="o">=</span> <span class="n">build_connection_string</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">_connection_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to build connection string&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Test existing connection</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Testing existing connection&quot;</span><span class="p">)</span>
            <span class="n">_connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT 1&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Existing connection is valid&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Existing connection test failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;will create new connection&quot;</span>
        <span class="p">)</span>
        <span class="n">_connection</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Create new connection if needed</span>
    <span class="k">if</span> <span class="n">_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating new database connection&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_connection</span> <span class="o">=</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">_connection_string</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database connection established successfully&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to establish database connection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">return</span> <span class="n">_connection</span>

<span class="k">def</span><span class="w"> </span><span class="nf">is_database_configured</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if database connection is configured&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Checking if database is configured&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Always true in this deployment</span>
</code></pre></div>
<p><strong>Connection pooling strategy:</strong>
- <strong>Singleton pattern:</strong> Reuse connections across requests
- <strong>Health checks:</strong> Test connection before use (<code>SELECT 1</code>)
- <strong>Automatic reconnection:</strong> If connection dies, create new one
- <strong>Secure credentials:</strong> Connection string stored in Key Vault</p>
<p><strong>Example connection string (from Key Vault):</strong>
<div class="highlight"><pre><span></span><code>Driver={ODBC Driver 18 for SQL Server};
Server=10.27.18.5,61002;
Database=ADP_AD_AAD;
UID=mcp_reader;
PWD=&lt;from-key-vault&gt;;
Encrypt=yes;
TrustServerCertificate=yes;
</code></pre></div></p>
<hr />
<h3 id="6-file-reading-with-sap-support">6. File Reading with SAP Support</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="k">def</span><span class="w"> </span><span class="nf">read_file</span><span class="p">(</span><span class="n">file_location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read CSV or Parquet file into Polars DataFrame&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading file: </span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">, type: </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_location</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="c1"># SAP files use semicolon delimiter</span>
            <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span> <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sap_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Using separator &#39;</span><span class="si">{</span><span class="n">separator</span><span class="si">}</span><span class="s2">&#39; for file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">file_location</span><span class="p">,</span>
                <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span>
                <span class="n">truncate_ragged_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Handle malformed rows</span>
                <span class="n">infer_schema_length</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>   <span class="c1"># Sample 10k rows for types</span>
                <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span>           <span class="c1"># Skip unparseable rows</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully read CSV file: </span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">file_location</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully read Parquet file: </span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file type: </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file type: </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read file </span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>

<span class="k">def</span><span class="w"> </span><span class="nf">read_file_list</span><span class="p">(</span>
    <span class="n">file_locations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> 
    <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read multiple files with same schema and concatenate&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Reading file list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_locations</span><span class="p">)</span><span class="si">}</span><span class="s2"> files of type </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Files to read: </span><span class="si">{</span><span class="n">file_locations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_location</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_locations</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Reading file </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_locations</span><span class="p">)</span><span class="si">}</span><span class="s2">: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_location</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">separator</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span> <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;sap_&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;,&#39;</span>

                <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                    <span class="n">file_location</span><span class="p">,</span>
                    <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span>
                    <span class="n">truncate_ragged_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">infer_schema_length</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                    <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully concatenated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span><span class="si">}</span><span class="s2"> CSV files, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;final shape: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;parquet&quot;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">file_locations</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully read </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_locations</span><span class="p">)</span><span class="si">}</span><span class="s2"> Parquet files, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;shape: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file type: </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file type: </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to read file list&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
<p><strong>Key features:</strong>
- <strong>SAP detection:</strong> Files prefixed with <code>sap_</code> automatically use <code>;</code> delimiter
- <strong>Robust parsing:</strong> Handles malformed CSVs gracefully
- <strong>Type inference:</strong> Samples 10,000 rows to detect column types accurately
- <strong>Performance:</strong> Polars is 10-50x faster than Pandas on large files
- <strong>Multi-file support:</strong> Concatenates files with same schema efficiently</p>
<hr />
<h3 id="7-user-context-extraction">7. User Context Extraction</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastmcp.server.dependencies</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_access_token</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_current_user_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns information about the authenticated Azure user&quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">get_access_token</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferred_username&quot;</span><span class="p">),</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="s2">&quot;oid&quot;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oid&quot;</span><span class="p">)</span>  <span class="c1"># Azure object ID</span>
    <span class="p">}</span>
</code></pre></div>
<p><strong>Available claims from Azure token:</strong>
- <strong><code>preferred_username</code></strong>: User's email (e.g., <code>john.doe@company.com</code>)
- <strong><code>name</code></strong>: Display name (e.g., <code>John Doe</code>)
- <strong><code>oid</code></strong>: Unique Azure object ID (use for database joins/auditing)</p>
<p><strong>Usage example in tools:</strong>
<div class="highlight"><pre><span></span><code><span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sensitive_tool</span><span class="p">():</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="n">get_current_user_info</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Tool called by: </span><span class="si">{</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Implement per-user authorization logic</span>
    <span class="k">if</span> <span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AUTHORIZED_USERS</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Unauthorized&quot;</span><span class="p">}</span>

    <span class="c1"># ... rest of tool logic</span>
</code></pre></div></p>
<hr />
<h3 id="8-mcp-tool-connection-info">8. MCP Tool: Connection Info</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>

<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_connection_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get information about configured data sources and connection status.</span>
<span class="sd">    Use to verify available data sources and check connection health.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">business_function</span> <span class="o">=</span> <span class="n">get_current_business_function</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;get_connection_info called for &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;business_function: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">file_pattern</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/mnt/azure/mcp/</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">/*.csv&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File pattern: </span><span class="si">{</span><span class="n">file_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">available_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">available_files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files matching pattern&quot;</span><span class="p">)</span>

    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;business_function&quot;</span><span class="p">:</span> <span class="n">business_function</span><span class="p">,</span>
        <span class="s2">&quot;file_sources&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">:</span> <span class="n">file_pattern</span><span class="p">,</span>
            <span class="s2">&quot;available_files&quot;</span><span class="p">:</span> <span class="n">available_files</span>
        <span class="p">},</span>
        <span class="s2">&quot;database_sources&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="n">is_database_configured</span><span class="p">(),</span>
            <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="s2">&quot;10.27.18.5,61002&quot;</span><span class="p">,</span>
            <span class="s2">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;ADP_AD_AAD&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># Test database connection and list tables</span>
    <span class="k">if</span> <span class="n">is_database_configured</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database is configured, retrieving available objects&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="c1"># List tables for this business function</span>
            <span class="n">db_objects_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT TABLE_SCHEMA, TABLE_NAME </span>
<span class="s2">                FROM INFORMATION_SCHEMA.TABLES </span>
<span class="s2">                WHERE TABLE_TYPE IN (&#39;BASE TABLE&#39;, &#39;VIEW&#39;)</span>
<span class="s2">                AND TABLE_SCHEMA = &#39;mcp&#39; </span>
<span class="s2">                AND TABLE_NAME LIKE &#39;</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">_%&#39;</span>
<span class="s2">                ORDER BY TABLE_SCHEMA, TABLE_NAME</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">db_objects_query</span><span class="p">)</span>
            <span class="n">db_objects</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="n">objects_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;table&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span> 
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">db_objects</span>
            <span class="p">]</span>

            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;database_sources&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;connected&quot;</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;database_sources&quot;</span><span class="p">][</span><span class="s2">&quot;available_objects&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">objects_list</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Database connection successful, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">objects_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> objects&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;database_sources&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;database_sources&quot;</span><span class="p">][</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Database object listing failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database not configured&quot;</span><span class="p">)</span>

    <span class="c1"># Log user for auditing</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_info</span> <span class="o">=</span> <span class="n">get_current_user_info</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Tool get_connection_info was called by: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with email </span><span class="si">{</span><span class="n">user_info</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not retrieve user info: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Returning connection info: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span>
</code></pre></div>
<p><strong>Returns example:</strong>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;business_function&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;it&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;file_sources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;pattern&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/mnt/azure/mcp/it/*.csv&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;available_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;/mnt/azure/mcp/it/device_inventory.csv&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;/mnt/azure/mcp/it/licenses.csv&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;database_sources&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;enabled&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;server&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.27.18.5,61002&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;database&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ADP_AD_AAD&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;connected&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;available_objects&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;schema&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mcp&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;table&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;it_employees&quot;</span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;schema&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;mcp&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;table&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;it_devices&quot;</span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<hr />
<h3 id="9-mcp-tool-data-catalog-auto-discovery">9. MCP Tool: Data Catalog (Auto-Discovery)</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_data_catalog</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the complete data catalog showing all available datasets.</span>

<span class="sd">    **ALWAYS CALL THIS TOOL FIRST before answering any data question.**</span>

<span class="sd">    Returns JSON catalog with:</span>
<span class="sd">    - &quot;source_type&quot;: &quot;file&quot; or &quot;database&quot;</span>
<span class="sd">    - &quot;query_tool&quot;: execute_polars_sql or execute_database_query</span>
<span class="sd">    - &quot;table_reference&quot;: &#39;self&#39; for files, &#39;schema.table&#39; for database</span>
<span class="sd">    - &quot;example_query&quot;: Sample query to adapt</span>
<span class="sd">    - Business descriptions, columns, rules, relationships</span>

<span class="sd">    The catalog contains all business context needed to write correct queries.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">business_function</span> <span class="o">=</span> <span class="n">get_current_business_function</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;get_data_catalog called for business_function: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">catalog_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/mnt/azure/mcp/</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">/data_catalog.json&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for catalog file: </span><span class="si">{</span><span class="n">catalog_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Load catalog file if exists</span>
    <span class="n">catalog_json</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">catalog_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">catalog_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded catalog file: </span><span class="si">{</span><span class="n">catalog_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to load catalog file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">catalog_json</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Build catalog with metadata from JSON + auto-discovery</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="s2">&quot;2.0&quot;</span><span class="p">),</span>
        <span class="s2">&quot;last_updated&quot;</span><span class="p">:</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_updated&quot;</span><span class="p">,</span> <span class="s2">&quot;auto-generated&quot;</span><span class="p">),</span>
        <span class="s2">&quot;README&quot;</span><span class="p">:</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;README&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;query_decision_tree&quot;</span><span class="p">:</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_decision_tree&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;anti_patterns&quot;</span><span class="p">:</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;anti_patterns&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;datasets&quot;</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>

    <span class="c1"># Auto-discover files on disk</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/mnt/azure/mcp/</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">/*.csv&quot;</span><span class="p">)</span> <span class="o">+</span> 
        <span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/mnt/azure/mcp/</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">/*.parquet&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span><span class="si">}</span><span class="s2"> files on disk for &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;business_function </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">file_keys_on_disk</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.parquet&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">file_keys_on_disk</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c1"># Use metadata from JSON if available, else minimal auto-discovery</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;source_type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
            <span class="s2">&quot;query_tool&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query_tool&quot;</span><span class="p">,</span> <span class="s2">&quot;execute_polars_sql&quot;</span><span class="p">),</span>
            <span class="s2">&quot;table_reference&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table_reference&quot;</span><span class="p">,</span> <span class="s2">&quot;self&quot;</span><span class="p">),</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">basename</span><span class="p">,</span>
            <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">),</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;description&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;Auto-discovered file - no metadata available&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;source_system&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_system&quot;</span><span class="p">),</span>
            <span class="s2">&quot;delimiter&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;delimiter&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">),</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="s2">&quot;business_rules&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;business_rules&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;common_queries&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;common_queries&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;related_datasets&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_datasets&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;usage_tip&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;usage_tip&quot;</span><span class="p">,</span> 
                <span class="sa">f</span><span class="s2">&quot;Use get_schema(file_location=&#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39;) for detailed schema&quot;</span>
            <span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Add any extra fields from JSON</span>
        <span class="k">for</span> <span class="n">extra_field</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extra_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
                <span class="n">dataset</span><span class="p">[</span><span class="n">extra_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">extra_field</span><span class="p">]</span>

        <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added/updated file dataset: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Auto-discover database tables</span>
    <span class="n">db_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">is_database_configured</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">get_db_connection</span><span class="p">()</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                SELECT TABLE_SCHEMA, TABLE_NAME </span>
<span class="s2">                FROM INFORMATION_SCHEMA.TABLES </span>
<span class="s2">                WHERE TABLE_TYPE IN (&#39;BASE TABLE&#39;, &#39;VIEW&#39;)</span>
<span class="s2">                AND TABLE_SCHEMA = &#39;mcp&#39; </span>
<span class="s2">                AND TABLE_NAME LIKE &#39;</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">_%&#39;</span>
<span class="s2">                ORDER BY TABLE_SCHEMA, TABLE_NAME</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span><span class="si">}</span><span class="s2"> database tables for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;business_function </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">db_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

                <span class="n">meta</span> <span class="o">=</span> <span class="n">catalog_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datasets&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>

                <span class="n">dataset</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;source_type&quot;</span><span class="p">:</span> <span class="s2">&quot;database&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;query_tool&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;query_tool&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;execute_database_query&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;table_reference&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;table_reference&quot;</span><span class="p">,</span> 
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;database_schema&quot;</span><span class="p">:</span> <span class="n">schema</span><span class="p">,</span>
                    <span class="s2">&quot;database_table&quot;</span><span class="p">:</span> <span class="n">table</span><span class="p">,</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;description&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;Auto-discovered database table - no metadata available&quot;</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;source_system&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_system&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;update_frequency&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;update_frequency&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="s2">&quot;business_rules&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;business_rules&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s2">&quot;common_queries&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;common_queries&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s2">&quot;related_datasets&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;related_datasets&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="s2">&quot;example_query&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;example_query&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;semantic_examples&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;semantic_examples&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="s2">&quot;usage_tip&quot;</span><span class="p">:</span> <span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="s2">&quot;usage_tip&quot;</span><span class="p">,</span> 
                        <span class="sa">f</span><span class="s2">&quot;Use get_schema_db(schema_name=&#39;</span><span class="si">{</span><span class="n">schema</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;table_name=&#39;</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&#39;) for detailed schema&quot;</span>
                    <span class="p">)</span>
                <span class="p">}</span>

                <span class="k">for</span> <span class="n">extra_field</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">extra_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
                        <span class="n">dataset</span><span class="p">[</span><span class="n">extra_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="p">[</span><span class="n">extra_field</span><span class="p">]</span>

                <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added/updated database dataset: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Database table discovery failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;database_discovery_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Only include datasets that are actually present (on disk or in db)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Reconciling catalog: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;total before filtering&quot;</span>
    <span class="p">)</span>
    <span class="n">present_keys</span> <span class="o">=</span> <span class="n">file_keys_on_disk</span> <span class="o">|</span> <span class="n">db_keys</span>
    <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">catalog</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">present_keys</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Final catalog has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> datasets &quot;</span>
        <span class="s2">&quot;after reconciliation&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<p><strong>Key features:</strong>
- <strong>Hybrid auto-discovery:</strong> Combines JSON metadata with filesystem/database introspection
- <strong>Business function isolation:</strong> Only shows datasets for current function
- <strong>Graceful degradation:</strong> Works even without <code>data_catalog.json</code> file
- <strong>Rich metadata:</strong> Provides all context LLM needs to write correct queries
- <strong>Tool routing:</strong> Tells LLM exactly which execution tool to use</p>
<hr />
<h3 id="10-mcp-tool-get-schema-files">10. MCP Tool: Get Schema (Files)</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_schema</span><span class="p">(</span>
    <span class="n">file_location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;csv or parquet&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get technical schema of a CSV or Parquet file.</span>

<span class="sd">    **Use for file-based datasets only.** </span>
<span class="sd">    For database tables, use get_schema_db().</span>

<span class="sd">    Returns column names and Polars data types.</span>
<span class="sd">    Call after get_data_catalog() to get detailed column information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">business_function</span> <span class="o">=</span> <span class="n">get_current_business_function</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;get_schema called for file: </span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;type: </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">, business_function: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Enforce that file_location is within the correct business function</span>
    <span class="n">allowed_prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/mnt/azure/mcp/</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">/&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_location</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">allowed_prefix</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Access denied: file_location &#39;</span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">&#39; is not &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;within the allowed business_function folder &#39;</span><span class="si">{</span><span class="n">allowed_prefix</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
            <span class="s2">&quot;You may only request schema for files in your assigned &quot;</span>
            <span class="s2">&quot;business_function folder.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">file_location</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span>
        <span class="n">schema_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">schema_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Successfully retrieved schema with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">schema_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Schema: </span><span class="si">{</span><span class="n">schema_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">schema_dict</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to read schema: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}]</span>
</code></pre></div>
<p><strong>Security enforcement:</strong>
- <strong>Path validation:</strong> Prevents directory traversal attacks
- <strong>Business function isolation:</strong> IT users can't read HR files
- <strong>Explicit error messages:</strong> Clear feedback on authorization failures</p>
<hr />
<h3 id="11-mcp-tool-get-schema-database">11. MCP Tool: Get Schema (Database)</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_schema_db</span><span class="p">(</span>
    <span class="n">schema_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Database schema name (e.g., &#39;mcp&#39;, &#39;dbo&#39;)&quot;</span>
    <span class="p">),</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Database table name&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get technical schema of a SQL Server database table.</span>

<span class="sd">    **Use for database tables only.** </span>
<span class="sd">    For CSV/Parquet files, use get_schema().</span>

<span class="sd">    Returns column names, data types, nullability, and primary key info.</span>
<span class="sd">    Call after get_data_catalog() to get detailed column information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">business_function</span> <span class="o">=</span> <span class="n">get_current_business_function</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;get_schema_db called for </span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;business_function: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_database_configured</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Database not configured&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No database connection configured.&quot;</span><span class="p">}]</span>

    <span class="c1"># Enforce table_name starts with business_function_</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Table name </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> does not match &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;business_function </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">get_db_connection</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span>
<span class="s2">                c.COLUMN_NAME, </span>
<span class="s2">                c.DATA_TYPE,</span>
<span class="s2">                c.CHARACTER_MAXIMUM_LENGTH,</span>
<span class="s2">                c.NUMERIC_PRECISION,</span>
<span class="s2">                c.NUMERIC_SCALE,</span>
<span class="s2">                c.IS_NULLABLE,</span>
<span class="s2">                c.COLUMN_DEFAULT,</span>
<span class="s2">                CASE WHEN pk.COLUMN_NAME IS NOT NULL </span>
<span class="s2">                     THEN &#39;YES&#39; ELSE &#39;NO&#39; END as IS_PRIMARY_KEY</span>
<span class="s2">            FROM INFORMATION_SCHEMA.COLUMNS c</span>
<span class="s2">            LEFT JOIN (</span>
<span class="s2">                SELECT ku.TABLE_SCHEMA, ku.TABLE_NAME, ku.COLUMN_NAME</span>
<span class="s2">                FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc</span>
<span class="s2">                JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE ku </span>
<span class="s2">                    ON tc.CONSTRAINT_NAME = ku.CONSTRAINT_NAME</span>
<span class="s2">                WHERE tc.CONSTRAINT_TYPE = &#39;PRIMARY KEY&#39;</span>
<span class="s2">            ) pk ON c.TABLE_SCHEMA = pk.TABLE_SCHEMA </span>
<span class="s2">                AND c.TABLE_NAME = pk.TABLE_NAME </span>
<span class="s2">                AND c.COLUMN_NAME = pk.COLUMN_NAME</span>
<span class="s2">            WHERE c.TABLE_SCHEMA = ? AND c.TABLE_NAME = ?</span>
<span class="s2">            ORDER BY c.ORDINAL_POSITION</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing schema query for </span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">schema_name</span><span class="p">,</span> <span class="n">table_name</span><span class="p">))</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Table not found: </span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2"> columns in </span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data_type</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">char_len</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">num_precision</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">num_scale</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">nullable</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;YES&quot;</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">is_pk</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;YES&quot;</span>

            <span class="c1"># Format type string</span>
            <span class="n">type_str</span> <span class="o">=</span> <span class="n">data_type</span>
            <span class="k">if</span> <span class="n">char_len</span><span class="p">:</span>
                <span class="n">type_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">char_len</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">elif</span> <span class="n">num_precision</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num_scale</span><span class="p">:</span>
                    <span class="n">type_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">num_precision</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">num_scale</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">type_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">num_precision</span><span class="si">}</span><span class="s2">)&quot;</span>

            <span class="n">schema</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;data_type&quot;</span><span class="p">:</span> <span class="n">type_str</span><span class="p">,</span>
                <span class="s2">&quot;nullable&quot;</span><span class="p">:</span> <span class="n">nullable</span><span class="p">,</span>
                <span class="s2">&quot;is_primary_key&quot;</span><span class="p">:</span> <span class="n">is_pk</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">default</span> <span class="k">if</span> <span class="n">default</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Column: </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">, type: </span><span class="si">{</span><span class="n">type_str</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;nullable: </span><span class="si">{</span><span class="n">nullable</span><span class="si">}</span><span class="s2">, pk: </span><span class="si">{</span><span class="n">is_pk</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">schema</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error retrieving schema: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}]</span>
</code></pre></div>
<p><strong>Comprehensive schema information:</strong>
- <strong>Data types:</strong> Including length/precision/scale
- <strong>Nullability:</strong> Whether NULL values allowed
- <strong>Primary keys:</strong> Identifies join columns
- <strong>Defaults:</strong> Column default values</p>
<hr />
<h3 id="12-mcp-tool-execute-polars-sql-files">12. MCP Tool: Execute Polars SQL (Files)</h3>
<div class="highlight"><pre><span></span><code><span class="n">query_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Polars SQL query. MUST use &#39;self&#39; as table name. </span>
<span class="s2">Supports: avg, count, sum, max, min, where, group by, order by, joins, etc.&quot;&quot;&quot;</span>

<span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">execute_polars_sql</span><span class="p">(</span>
    <span class="n">file_locations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">query_description</span><span class="p">),</span>
    <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;csv or parquet&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute SQL query on CSV or Parquet files using Polars.</span>

<span class="sd">    **Use for file-based datasets only.** </span>
<span class="sd">    For database tables, use execute_database_query().</span>

<span class="sd">    **CRITICAL:** Query MUST use &#39;self&#39; as table name, NOT the filename.</span>

<span class="sd">    Example: execute_polars_sql(</span>
<span class="sd">        file_locations=[&quot;data/employees.csv&quot;],</span>
<span class="sd">        query=&quot;SELECT COUNT(*) FROM self WHERE IsActive = true&quot;</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">business_function</span> <span class="o">=</span> <span class="n">get_current_business_function</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;execute_polars_sql called for business_function: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File locations (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_locations</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">file_locations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File type: </span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validation: Check for common mistakes</span>
    <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Check if query references database schema (wrong tool)</span>
    <span class="k">if</span> <span class="s2">&quot;mcp.&quot;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">or</span> <span class="s2">&quot;dbo.&quot;</span> <span class="ow">in</span> <span class="n">query</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">schema</span> <span class="ow">in</span> <span class="n">query</span> <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mcp.&quot;</span><span class="p">,</span> <span class="s2">&quot;dbo.&quot;</span><span class="p">,</span> <span class="s2">&quot;hr.&quot;</span><span class="p">,</span> <span class="s2">&quot;sales.&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;WRONG TOOL: This query references a database table &quot;</span>
            <span class="s2">&quot;(schema.table format). Use execute_database_query() instead.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
            <span class="s2">&quot;hint&quot;</span><span class="p">:</span> <span class="s2">&quot;File queries must use &#39;self&#39; as table name, &quot;</span>
                    <span class="s2">&quot;not schema.table&quot;</span><span class="p">,</span>
            <span class="s2">&quot;your_query&quot;</span><span class="p">:</span> <span class="n">query</span>
        <span class="p">}]</span>

    <span class="c1"># Check if query uses &#39;self&#39; (required for Polars)</span>
    <span class="k">if</span> <span class="s2">&quot;self&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_lower</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;INVALID QUERY: Polars SQL queries must use &#39;self&#39; &quot;</span>
            <span class="s2">&quot;as the table name.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
            <span class="s2">&quot;hint&quot;</span><span class="p">:</span> <span class="s2">&quot;Change your query to: SELECT ... FROM self WHERE ...&quot;</span><span class="p">,</span>
            <span class="s2">&quot;your_query&quot;</span><span class="p">:</span> <span class="n">query</span>
        <span class="p">}]</span>

    <span class="c1"># Enforce that all file_locations are within business function folder</span>
    <span class="n">allowed_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;/mnt/azure/mcp/</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">/&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">file_location</span> <span class="ow">in</span> <span class="n">file_locations</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_location</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">allowed_prefix</span><span class="p">):</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Access denied: file_location &#39;</span><span class="si">{</span><span class="n">file_location</span><span class="si">}</span><span class="s2">&#39; is not &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;within the allowed business_function folder &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">allowed_prefix</span><span class="si">}</span><span class="s2">&#39;. You may only query files in your &quot;</span>
                <span class="s2">&quot;assigned business_function folder.&quot;</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span> <span class="s2">&quot;your_query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading files into DataFrame&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">read_file_list</span><span class="p">(</span><span class="n">file_locations</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataFrame loaded, shape: </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Executing SQL query on DataFrame&quot;</span><span class="p">)</span>
        <span class="n">op_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query executed successfully, result shape: </span><span class="si">{</span><span class="n">op_df</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">output_records</span> <span class="o">=</span> <span class="n">op_df</span><span class="o">.</span><span class="n">to_dicts</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Returning </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_records</span><span class="p">)</span><span class="si">}</span><span class="s2"> records&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;First record (if any): &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">output_records</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No records&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">output_records</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Query execution failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span> <span class="s2">&quot;your_query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}]</span>
</code></pre></div>
<p><strong>Validation and security:</strong>
- <strong>Tool detection:</strong> Catches wrong tool usage (database vs file queries)
- <strong>Syntax validation:</strong> Ensures 'self' is used as table name
- <strong>Path validation:</strong> Prevents access to files outside business function
- <strong>Error handling:</strong> Returns helpful error messages to LLM</p>
<hr />
<h3 id="13-mcp-tool-execute-database-query-sql-server">13. MCP Tool: Execute Database Query (SQL Server)</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@mcp</span><span class="o">.</span><span class="n">tool</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">execute_database_query</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;T-SQL query to execute on SQL Server database&quot;</span>
    <span class="p">),</span>
    <span class="n">max_rows</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum rows to return (default: 1000, set to 0 for unlimited)&quot;</span>
    <span class="p">)</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute T-SQL queries on SQL Server database tables.</span>

<span class="sd">    **Use for database tables only.** </span>
<span class="sd">    For CSV/Parquet files, use execute_polars_sql().</span>

<span class="sd">    **CRITICAL:** Use schema.table format (e.g., mcp.employees), NOT &#39;self&#39;.</span>

<span class="sd">    Example: execute_database_query(</span>
<span class="sd">        query=&quot;SELECT COUNT(*) FROM mcp.vw_ADP_Employee_Daily_Snapshot </span>
<span class="sd">               WHERE Position_Status = &#39;Active&#39;&quot;</span>
<span class="sd">    )</span>

<span class="sd">    Default limit: 1000 rows. Set max_rows=0 for unlimited.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">business_function</span> <span class="o">=</span> <span class="n">get_current_business_function</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;execute_database_query called for &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;business_function: </span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max rows: </span><span class="si">{</span><span class="n">max_rows</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_database_configured</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Database not configured&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No database connection configured.&quot;</span><span class="p">}]</span>

    <span class="c1"># Validation: Check for common mistakes</span>
    <span class="n">query_lower</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Check if query uses &#39;self&#39; (wrong tool)</span>
    <span class="k">if</span> <span class="s2">&quot; self&quot;</span> <span class="ow">in</span> <span class="n">query_lower</span> <span class="ow">or</span> <span class="s2">&quot;from self&quot;</span> <span class="ow">in</span> <span class="n">query_lower</span> <span class="ow">or</span> \
       <span class="s2">&quot;join self&quot;</span> <span class="ow">in</span> <span class="n">query_lower</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;WRONG TOOL: This query uses &#39;self&#39; as table name. &quot;</span>
            <span class="s2">&quot;Use execute_polars_sql() for file-based queries.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
            <span class="s2">&quot;hint&quot;</span><span class="p">:</span> <span class="s2">&quot;Database queries must use schema.table format &quot;</span>
                    <span class="s2">&quot;(e.g., mcp.employees), not &#39;self&#39;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;your_query&quot;</span><span class="p">:</span> <span class="n">query</span>
        <span class="p">}]</span>

    <span class="c1"># Check if query has schema.table format</span>
    <span class="k">if</span> <span class="s2">&quot;mcp.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_lower</span> <span class="ow">and</span> <span class="s2">&quot;dbo.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_lower</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;INVALID QUERY: Database queries must use schema.table format.&quot;</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span>
            <span class="s2">&quot;hint&quot;</span><span class="p">:</span> <span class="s2">&quot;Use: SELECT ... FROM mcp.table_name or dbo.table_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;your_query&quot;</span><span class="p">:</span> <span class="n">query</span>
        <span class="p">}]</span>

    <span class="c1"># Validate business_function in table name</span>
    <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query_lower</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Query does not appear to reference business_function &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">business_function</span><span class="si">}</span><span class="s2">&#39; tables&quot;</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">get_db_connection</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># Add TOP clause if not present and max_rows is set</span>
        <span class="n">modified_query</span> <span class="o">=</span> <span class="n">query</span>
        <span class="k">if</span> <span class="n">max_rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">query_upper</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">query_upper</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SELECT TOP&quot;</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="n">query_upper</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SELECT&quot;</span><span class="p">):</span>
                <span class="n">modified_query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># Insert TOP clause after SELECT</span>
                <span class="n">select_pos</span> <span class="o">=</span> <span class="n">modified_query</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;SELECT&quot;</span><span class="p">)</span>
                <span class="n">modified_query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">modified_query</span><span class="p">[:</span><span class="n">select_pos</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">+</span> 
                    <span class="sa">f</span><span class="s2">&quot; TOP </span><span class="si">{</span><span class="n">max_rows</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> 
                    <span class="n">modified_query</span><span class="p">[</span><span class="n">select_pos</span> <span class="o">+</span> <span class="mi">6</span><span class="p">:]</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added TOP </span><span class="si">{</span><span class="n">max_rows</span><span class="si">}</span><span class="s2"> clause to query&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing modified query: </span><span class="si">{</span><span class="n">modified_query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">modified_query</span><span class="p">)</span>

        <span class="c1"># Get column names</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result columns (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Fetch results</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">row_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">row_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Convert values to JSON-serializable types</span>
            <span class="n">row_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="c1"># Handle datetime and other types</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;isoformat&#39;</span><span class="p">):</span>
                    <span class="n">row_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">row_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row_dict</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_dict</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query executed successfully, returned </span><span class="si">{</span><span class="n">row_count</span><span class="si">}</span><span class="s2"> rows&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First row: </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Query execution error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">,</span> <span class="s2">&quot;your_query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">}]</span>
</code></pre></div>
<p><strong>Key features:</strong>
- <strong>Automatic row limiting:</strong> Adds TOP clause to prevent massive result sets
- <strong>JSON serialization:</strong> Converts datetime and other types properly
- <strong>Tool validation:</strong> Catches wrong tool usage (file vs database queries)
- <strong>Security:</strong> Validates business function table naming</p>
<hr />
<h3 id="14-main-entry-point-and-server-startup">14. Main Entry Point and Server Startup</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main entry point for MCP server&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MAIN: Starting single MCP Server on port 8000&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create the FastMCP HTTP app</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">mcp</span><span class="o">.</span><span class="n">http_app</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;FastMCP HTTP app created successfully&quot;</span><span class="p">)</span>

        <span class="c1"># Add the business function extraction middleware</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Adding BusinessFunctionExtractionMiddleware to app&quot;</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">add_middleware</span><span class="p">(</span><span class="n">BusinessFunctionExtractionMiddleware</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Middleware added successfully&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server configuration:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - Host: 0.0.0.0&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - Port: 8000&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - Functions supported: IT, HR, FIN&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  - Functions extraction: Via Query String (mcp?function=XXX)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="c1"># Run the server - this blocks indefinitely</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting Uvicorn server...&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span>
            <span class="n">app</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
            <span class="n">access_log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="s2">&quot;asyncio&quot;</span><span class="p">,</span>
            <span class="n">timeout_keep_alive</span><span class="o">=</span><span class="mi">75</span>
        <span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to start server: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MAIN: MCP Server shutdown complete&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Script execution started - Single Process Mode&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MAIN: Keyboard interrupt received, shutting down...&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fatal error in main execution: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>
<p><strong>Server configuration:</strong>
- <strong>Port 8000:</strong> Standard HTTP port for MCP servers
- <strong>Host 0.0.0.0:</strong> Listen on all network interfaces
- <strong>Async event loop:</strong> Supports concurrent requests
- <strong>Keep-alive timeout:</strong> 75 seconds for long-running queries
- <strong>Access logging:</strong> All requests logged for auditing</p>
<hr />
<h2 id="deployment-azure-container-instance-with-tls-offloading">Deployment: Azure Container Instance with TLS Offloading</h2>
<h3 id="container-build-and-deployment">Container Build and Deployment</h3>
<p><strong>1. Dockerfile:</strong>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">mcr.microsoft.com/devcontainers/python:3</span>

<span class="c"># Keeps Python from generating .pyc files in the container</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span>

<span class="c"># Install only necessary packages for MCP Analyst</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>build-essential<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python3-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>git<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>curl<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>cifs-utils<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>apt-get<span class="w"> </span>clean<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*

<span class="c"># Copy and install Python dependencies</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Add Microsoft GPG key</span>
<span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>-fsSL<span class="w"> </span>https://packages.microsoft.com/keys/microsoft.asc<span class="w"> </span><span class="p">|</span><span class="w"> </span>gpg<span class="w"> </span>--dearmor<span class="w"> </span>-o<span class="w"> </span>/usr/share/keyrings/microsoft-prod.gpg

<span class="c"># Add Microsoft SQL Server repository</span>
<span class="k">RUN</span><span class="w"> </span>curl<span class="w"> </span>https://packages.microsoft.com/config/debian/12/prod.list<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/mssql-release.list

<span class="c"># Install Microsoft SQL Server related packages</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="nv">ACCEPT_EULA</span><span class="o">=</span>Y<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>msodbcsql18<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>mssql-tools18

<span class="c"># Add MS SQL Server tools to PATH</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=&quot;$PATH:/opt/mssql-tools18/bin&quot;&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc<span class="w"> </span>

<span class="c"># Clean up</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>clean<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*


<span class="c">#Argument passed in via Command line </span>
<span class="k">ARG</span><span class="w"> </span>GITHUB_PAT

<span class="c"># Clone the private repository using the build argument</span>
<span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://<span class="nv">$GITHUB_PAT</span>@github.com/GDEnergyproducts/GDEP-MCP-ANALYST.git<span class="w"> </span>/app

<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>

<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>scripts/container/mountstorage.sh

<span class="c"># Create a startup script that runs mcp server</span>
<span class="k">RUN</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;#!/bin/bash\n\</span>
<span class="s1">set -e\n\</span>
<span class="s1">echo &quot;Starting container initialization...&quot;\n\</span>
<span class="s1">echo &quot;Starting analyst.py...&quot;\n\</span>
<span class="s1">python /app/src/analyst.py\n\</span>
<span class="s1">&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/app/start.sh<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/app/start.sh

<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/app/start.sh&quot;</span><span class="p">]</span>
</code></pre></div></p>
<p><strong>2. requirements.txt:</strong>
<div class="highlight"><pre><span></span><code># Core MCP dependencies
polars&gt;=0.20.0
pydantic&gt;=2.0.0

# Azure dependencies (from your existing setup)
azure-identity
azure-keyvault-secrets

# Data processing
pandas
pyarrow&gt;=14.0.0
pyodbc&gt;=5.3.0

# Development/debugging tools
pytest
ipython

# Need this !!
fastmcp
</code></pre></div></p>
<h3 id="tls-offloading-with-fortigate">TLS Offloading with FortiGate</h3>
<p><strong>Why TLS offloading at the edge?</strong>
- <strong>SSL/TLS termination:</strong> FortiGate handles all encryption/decryption
- <strong>Certificate management:</strong> Centralized SSL cert renewal
- <strong>Performance:</strong> Offload crypto operations from container
- <strong>Security:</strong> Web Application Firewall (WAF) protection
- <strong>Inspection:</strong> Deep packet inspection for threats</p>
<p><strong>FortiGate configuration (simplified):</strong>
<div class="highlight"><pre><span></span><code>config firewall vip
    edit &quot;mcp-analyst-vip&quot;
        set extip 203.0.113.10
        set mappedip 10.0.1.100  # Container internal IP
        set extintf &quot;wan1&quot;
        set portforward enable
        set extport 443
        set mappedport 8000
        set ssl-certificate &quot;wildcard-cert&quot;
    next
end

config firewall policy
    edit 1
        set name &quot;Allow-MCP-HTTPS&quot;
        set srcintf &quot;wan1&quot;
        set dstintf &quot;internal&quot;
        set srcaddr &quot;all&quot;
        set dstaddr &quot;mcp-analyst-vip&quot;
        set action accept
        set schedule &quot;always&quot;
        set service &quot;HTTPS&quot;
        set utm-status enable
        set ssl-ssh-profile &quot;certificate-inspection&quot;
        set av-profile &quot;default&quot;
        set webfilter-profile &quot;default&quot;
        set ips-sensor &quot;default&quot;
    next
end
</code></pre></div></p>
<p><strong>Result:</strong>
- External URL: <code>https://mcp.gdenergyproducts.com</code> (port 443)
- Internal traffic: HTTP to container (port 8000)
- TLS handled by FortiGate with corporate SSL certificate</p>
<hr />
<h2 id="claude-desktop-configuration">Claude Desktop Configuration</h2>
<p>To connect Claude Desktop to your MCP server:</p>
<ol>
<li>Open Claude Desktop and go to <strong>File â†’ Settings</strong>.</li>
<li>Select <strong>Connector</strong>, then click <strong>Add Connector</strong>.</li>
<li>Enter the following URL (replace <code>function=it</code> as needed):
     <div class="highlight"><pre><span></span><code>https://mcp.gdenergyproducts.com/mcp?function=it
</code></pre></div></li>
<li>Click <strong>Connect</strong> and go through the OAuth authentication process.</li>
<li>If Claude Desktop does not restart automatically, restart it manually.</li>
<li>After restart, go back to <strong>Configure</strong> and allow access as appropriate. If not, you will be prompted for access when each tool is used.</li>
</ol>
<p><strong>4. Start asking questions!</strong>
- "How many Windows devices do we have?"
- "Show me employees terminated in the last 90 days"
- "What's our Office 365 license utilization?"</p>
<hr />
<h2 id="security-best-practices">Security Best Practices</h2>
<h3 id="1-authentication-and-authorization">1. Authentication and Authorization</h3>
<ul>
<li>âœ… <strong>OAuth 2.0 (Azure Entra ID) only:</strong> No API keys or basic auth</li>
<li>âœ… <strong>Per-user context:</strong> Track who queries what</li>
<li>âœ… <strong>Business function isolation:</strong> Users can't cross boundaries</li>
<li>âœ… <strong>Audit logging:</strong> Every tool call logged with user identity</li>
</ul>
<h3 id="2-data-protection">2. Data Protection</h3>
<ul>
<li>âœ… <strong>TLS in transit:</strong> All external traffic encrypted</li>
<li>âœ… <strong>No data exfiltration:</strong> Results returned only to authenticated user</li>
<li>âœ… <strong>Path validation:</strong> Prevents directory traversal</li>
<li>âœ… <strong>Query validation:</strong> Catches SQL injection attempts</li>
</ul>
<h3 id="3-secrets-management">3. Secrets Management</h3>
<ul>
<li>âœ… <strong>Azure Key Vault:</strong> All secrets stored securely</li>
<li>âœ… <strong>No hardcoded credentials:</strong> Injected at runtime</li>
<li>âœ… <strong>Least privilege:</strong> Service principals with minimal permissions</li>
<li>âœ… <strong>Secret rotation:</strong> Automated via Key Vault</li>
</ul>
<h3 id="4-network-security">4. Network Security</h3>
<ul>
<li>âœ… <strong>TLS offloading:</strong> FortiGate terminates SSL/TLS</li>
<li>âœ… <strong>WAF protection:</strong> Web Application Firewall blocks attacks</li>
<li>âœ… <strong>Internal-only database:</strong> No public internet exposure</li>
<li>âœ… <strong>VNet integration:</strong> Container in private virtual network</li>
</ul>
<hr />
<h2 id="performance-and-scalability">Performance and Scalability</h2>
<h3 id="performance-characteristics">Performance Characteristics</h3>
<p><strong>File queries (Polars):</strong>
- 1 million rows: ~1-2 seconds
- 10 million rows: ~5-10 seconds
- Concurrent users: 20-50 simultaneous queries</p>
<p><strong>Database queries (SQL Server):</strong>
- Simple SELECT: &lt;100ms
- Complex joins: 1-5 seconds
- Limited by database performance, not MCP server</p>
<p><strong>Memory usage:</strong>
- Base: ~200MB
- Per concurrent query: +50-500MB (depends on data size)
- Recommended: 4GB RAM for 10+ concurrent users</p>
<h3 id="scaling-strategies">Scaling Strategies</h3>
<p><strong>Vertical scaling (single container):</strong>
- Increase CPU/RAM allocation
- Good for up to 50 concurrent users</p>
<p><strong>Horizontal scaling (multiple containers):</strong>
- Deploy behind Azure Load Balancer
- Session affinity not required (stateless)
- Scale to 100+ users</p>
<p><strong>Database optimization:</strong>
- Create indexed views for common queries
- Partition large tables by business function
- Use columnstore indexes for analytics</p>
<hr />
<h2 id="monitoring-and-troubleshooting">Monitoring and Troubleshooting</h2>
<h3 id="key-metrics-to-monitor">Key Metrics to Monitor</h3>
<p><strong>1. Application logs (<code>/mnt/azure/logs/gdepmcp.log</code>):</strong>
- Tool call frequency and duration
- Authentication failures
- Query errors
- User activity patterns</p>
<p><strong>2. Container metrics (Azure Monitor):</strong>
- CPU utilization
- Memory usage
- Network throughput
- Container restart count</p>
<p><strong>3. Database metrics (SQL Server DMVs):</strong>
- Long-running queries
- Connection pool usage
- Lock contention
- Index usage</p>
<h3 id="common-issues-and-solutions">Common Issues and Solutions</h3>
<p><strong>Issue:</strong> OAuth authentication fails
<strong>Solution:</strong> 
- Verify <code>accessTokenAcceptedVersion: 2</code> in manifest
- Check redirect URIs include Claude callback URL
- Ensure <code>access_as_user</code> scope is granted admin consent</p>
<p><strong>Issue:</strong> "Access denied" errors for files
<strong>Solution:</strong>
- Verify business function in URL matches data folder
- Check file permissions in Azure File Share
- Validate path in <code>get_schema()</code> or <code>execute_polars_sql()</code></p>
<p><strong>Issue:</strong> Database queries timeout
<strong>Solution:</strong>
- Check network connectivity to SQL Server
- Verify firewall allows container IP
- Optimize query with indexes
- Increase <code>max_rows</code> limit or add WHERE clause</p>
<p><strong>Issue:</strong> Container crashes with OOM (Out of Memory)
<strong>Solution:</strong>
- Increase container memory allocation
- Add pagination to large queries
- Limit <code>infer_schema_length</code> in Polars
- Review concurrent user load</p>
<hr />
<h2 id="lessons-learned">Lessons Learned</h2>
<h3 id="what-worked-well">What Worked Well</h3>
<ol>
<li><strong>OAuth 2.0 (Azure Entra ID) integration:</strong> Seamless enterprise SSO</li>
<li><strong>Multi-tenant architecture:</strong> Single server for all business functions</li>
<li><strong>Polars performance:</strong> Handles millions of rows effortlessly</li>
<li><strong>Data catalog:</strong> LLM generates correct queries consistently</li>
<li><strong>TLS offloading:</strong> Simplified container deployment</li>
<li><strong>Key Vault:</strong> Secure, centralized secrets management</li>
</ol>
<h3 id="challenges-and-solutions">Challenges and Solutions</h3>
<ol>
<li><strong>OAuth version gotcha:</strong> Manually edit manifest to v2.0</li>
<li>
<p><em>Solution:</em> Document clearly in setup guide</p>
</li>
<li>
<p><strong>Claude Desktop callback:</strong> Not in standard OAuth flow</p>
</li>
<li>
<p><em>Solution:</em> Add <code>claude.ai/api/mcp/auth_callback</code> to redirect URIs</p>
</li>
<li>
<p><strong>SAP delimiter detection:</strong> Semicolon vs comma</p>
</li>
<li>
<p><em>Solution:</em> Detect <code>sap_</code> prefix in filename</p>
</li>
<li>
<p><strong>Connection pooling:</strong> Database connections timing out</p>
</li>
<li>
<p><em>Solution:</em> Implement health checks and reconnection logic</p>
</li>
<li>
<p><strong>Log file growth:</strong> Filled disk in production</p>
</li>
<li><em>Solution:</em> Use <code>RotatingFileHandler</code> with size limits</li>
</ol>
<h3 id="future-enhancements">Future Enhancements</h3>
<ol>
<li><strong>Row-level security:</strong> Filter data based on user's Azure groups</li>
<li><strong>Query caching:</strong> Redis cache for repeated queries</li>
<li><strong>Rate limiting:</strong> Prevent abuse by individual users</li>
<li><strong>Advanced analytics:</strong> Support for Python/R code execution</li>
<li><strong>Mobile app:</strong> Native iOS/Android client with OAuth</li>
<li><strong>Real-time data:</strong> WebSocket streaming for live dashboards</li>
</ol>
<hr />
<h2 id="conclusion">Conclusion</h2>
<p>The evolution from stdio-based to HTTPS-based MCP server represents a quantum leap in enterprise readiness:</p>
<ul>
<li><strong>From single-user to multi-tenant:</strong> One server, many users, isolated data</li>
<li><strong>From no auth to OAuth 2.0 (Azure Entra ID):</strong> Enterprise-grade security and SSO</li>
<li><strong>From local to cloud:</strong> Scalable, containerized deployment</li>
<li><strong>From manual to automated:</strong> Zero per-user setup, instant access</li>
</ul>
<p>This architecture enables true self-service analytics for business users while maintaining the security, governance, and scalability requirements of enterprise IT. By combining Azure Entra ID, containerization, TLS offloading, and multi-tenant data isolation, you can deliver LLM-powered analytics that business users love and IT teams trust.</p>
<p><strong>The result:</strong> Business leaders can ask any question, across any dataset, with natural languageâ€”securely, instantly, and without waiting for IT.</p>
<hr />
<h2 id="references-and-credits">References and Credits</h2>
<ul>
<li><a href="https://github.com/jlowin/fastmcp">FastMCP Documentation</a> â€“ MCP server framework with OAuth support</li>
<li><a href="https://pola.rs/">Polars DataFrame Library</a> â€“ High-performance data processing</li>
<li><a href="https://claude.ai/">Claude Desktop</a> â€“ LLM client with custom HTTPS connectors</li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="November 4, 2025 17:59:00 UTC">November 4, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.sections", "content.code.annotate", "content.code.copy"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../assets/custom.js"></script>
      
    
  </body>
</html>